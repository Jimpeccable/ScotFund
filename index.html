<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScotFund Pro | Universal Scottish Funding Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .scanning-active { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .log-container::-webkit-scrollbar { width: 4px; }
        .log-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media (max-width: 1023px) {
            #sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            #sidebar.open { transform: translateX(0); }
        }
        .quality-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .quality-high { background: #dcfce7; color: #166534; }
        .quality-medium { background: #fef3c7; color: #854d0e; }
        .quality-low { background: #fee2e2; color: #991b1b; }
        .blacklisted-item { opacity: 0.5; text-decoration: line-through; }
        .whitelist-badge { background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-[#f8fafc] text-[#1e293b]">

    <!-- Global Scan Progress Bar -->
    <div id="global-progress-container" class="fixed top-0 left-0 w-full h-1 z-[100] bg-slate-100 hidden">
        <div id="global-progress-bar" class="h-full bg-gradient-to-r from-indigo-600 to-purple-600 transition-all duration-500 ease-out shadow-[0_0_12px_rgba(79,70,229,0.5)]"></div>
    </div>

    <!-- Mobile Header -->
    <div class="lg:hidden bg-white border-b border-slate-200 p-4 flex items-center justify-between sticky top-0 z-[60]">
        <button onclick="showSection('dashboard')" class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg text-white">
                <i data-lucide="shield-check" class="w-5 h-5"></i>
            </div>
            <h1 class="text-lg font-bold">ScotFund<span class="text-indigo-600">Pro</span> <span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded ml-1">v8.0</span></h1>
        </button>
        <button onclick="toggleSidebar()" class="p-2 bg-slate-100 rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white border-r border-slate-200 flex flex-col p-6 z-50 lg:translate-x-0 overflow-y-auto">
        <button onclick="showSection('dashboard')" class="hidden lg:flex items-center gap-3 mb-10 hover:opacity-80 transition-opacity">
            <div class="bg-indigo-600 p-2 rounded-xl text-white">
                <i data-lucide="shield-check"></i>
            </div>
            <h1 class="text-xl font-bold">ScotFund<span class="text-indigo-600">Pro</span></h1>
        </button>
        
        <nav class="space-y-1 flex-1">
            <button onclick="showSection('dashboard')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="dashboard">
                <i data-lucide="home" class="w-5 h-5"></i> Home
            </button>
            <button onclick="showSection('sources')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="sources">
                <i data-lucide="globe" class="w-5 h-5"></i> Sources
            </button>
            <button onclick="showSection('shortlist')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="shortlist">
                <i data-lucide="star" class="w-5 h-5"></i> Shortlist
            </button>
            <button onclick="showSection('blacklist')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="blacklist">
                <i data-lucide="shield-ban" class="w-5 h-5"></i> Blacklist
            </button>
            <button onclick="showSection('scheduler')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="scheduler">
                <i data-lucide="clock" class="w-5 h-5"></i> Scheduler
            </button>
            <button onclick="showSection('reports')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="reports">
                <i data-lucide="file-text" class="w-5 h-5"></i> Console
            </button>
            <button onclick="showSection('profile')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="profile">
                <i data-lucide="user" class="w-5 h-5"></i> My Profile
            </button>
            <button onclick="showSection('settings')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 transition-all font-medium" data-id="settings">
                <i data-lucide="settings" class="w-5 h-5"></i> Settings
            </button>
        </nav>

        <div class="mt-auto pt-6 border-t border-slate-100 space-y-3">
            <div id="user-display" class="p-3 bg-slate-50 rounded-xl hidden mb-2">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Account</p>
                <p id="user-name-display" class="text-sm font-bold text-slate-900 truncate"></p>
                <p id="user-org-display" class="text-[10px] text-slate-500 truncate"></p>
                <button onclick="logout()" class="text-[9px] font-bold text-red-600 uppercase mt-2 hover:underline">Logout</button>
            </div>
            <div id="scan-status-indicator" class="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase tracking-widest">
                <span class="w-2 h-2 rounded-full bg-slate-300"></span> System Idle
            </div>
            <button onclick="runUltimateScan()" id="main-scan-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-100 flex items-center justify-center gap-2 transition-transform active:scale-95">
                <i data-lucide="zap" class="w-4 h-4" id="btn-icon"></i> <span id="btn-text">Scan</span>
            </button>
        </div>
    </div>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <main class="lg:ml-64 p-4 md:p-8">
        
        <!-- DASHBOARD -->
        <section id="dashboard" class="space-y-8">
            <header class="flex flex-col md:flex-row md:items-start justify-between gap-4">
                <div>
                    <h2 class="text-3xl font-bold mb-2">ScotFund Pro: Universal Intelligence</h2>
                    <p class="text-slate-500">Advanced funding discovery for all Scottish charities, groups, and organisations</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <div class="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg">
                        <input type="checkbox" id="report-new-only" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="report-new-only" class="text-xs font-bold text-slate-600 uppercase">New Only</label>
                    </div>
                    <button onclick="runUltimateScan()" class="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-bold hover:from-indigo-700 hover:to-purple-700 transition-all flex items-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Scan
                    </button>
                    <button onclick="generatePDFReport()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all flex items-center gap-2">
                        <i data-lucide="file-down" class="w-4 h-4"></i> PDF Report
                    </button>
                </div>
            </header>

            <!-- Enhanced Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Total</p>
                    <p id="stat-total" class="text-3xl font-bold text-slate-900">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Verified</p>
                    <p id="stat-verified" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Closing Soon</p>
                    <p id="stat-closing" class="text-3xl font-bold text-orange-600">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Large Grants</p>
                    <p id="stat-large" class="text-3xl font-bold text-purple-600">0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Avg Amount</p>
                    <p id="stat-avg" class="text-2xl font-bold text-slate-900">¬£0</p>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Last Scan</p>
                    <p id="stat-last-scan" class="text-xs font-bold text-slate-900">Never</p>
                </div>
            </div>

            <!-- Top 3 Opportunities -->
            <div id="top-3-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-gradient-to-br from-indigo-900 to-indigo-800 rounded-2xl p-6 text-white border border-indigo-700 shadow-xl shadow-indigo-100/50">
                    <p class="text-indigo-300 text-[10px] font-bold uppercase tracking-widest mb-2">‚≠ê Top Pick 1</p>
                    <h3 class="text-lg font-bold mb-2">Ready to Scan</h3>
                    <p class="text-indigo-100 text-xs mb-4 leading-relaxed">Run a scan to discover top verified funding opportunities across Scotland.</p>
                </div>
                <div class="bg-gradient-to-br from-purple-900 to-purple-800 rounded-2xl p-6 text-white border border-purple-700 shadow-xl shadow-purple-100/50">
                    <p class="text-purple-300 text-[10px] font-bold uppercase tracking-widest mb-2">‚≠ê Top Pick 2</p>
                    <h3 class="text-lg font-bold mb-2">Advanced Ranking</h3>
                    <p class="text-purple-100 text-xs mb-4 leading-relaxed">Our intelligence engine ranks funds by relevance, quality, and urgency.</p>
                </div>
                <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl p-6 text-white border border-slate-700 shadow-xl shadow-slate-100/50">
                    <p class="text-slate-300 text-[10px] font-bold uppercase tracking-widest mb-2">‚≠ê Top Pick 3</p>
                    <h3 class="text-lg font-bold mb-2">Verified Links</h3>
                    <p class="text-slate-100 text-xs mb-4 leading-relaxed">Direct access to official application forms and eligibility guidance.</p>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="bg-white rounded-2xl border border-slate-200 p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Search</label>
                        <input type="text" id="search-input" oninput="applyFilters()" placeholder="Search opportunities..." class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Sector</label>
                        <select id="filter-category" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">All Sectors</option>
                            <option value="community">Community</option>
                            <option value="play">Play & Outdoor</option>
                            <option value="youth">Youth & Children</option>
                            <option value="charity">Charity & Third Sector</option>
                            <option value="arts">Arts & Culture</option>
                            <option value="sport">Sport & Recreation</option>
                            <option value="education">Education & Training</option>
                            <option value="environment">Environment</option>
                            <option value="health">Health & Wellbeing</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Amount Range</label>
                        <select id="filter-amount" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">All Amounts</option>
                            <option value="0-1000">Under ¬£1,000</option>
                            <option value="1000-5000">¬£1,000 - ¬£5,000</option>
                            <option value="5000-25000">¬£5,000 - ¬£25,000</option>
                            <option value="25000-100000">¬£25,000 - ¬£100,000</option>
                            <option value="100000+">Over ¬£100,000</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Quality</label>
                        <select id="filter-quality" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">All Quality</option>
                            <option value="high">‚≠ê Verified Only</option>
                            <option value="medium">üìã Partial+</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-indigo-600 uppercase mb-2 block">Priority Area</label>
                        <select id="priority-area" onchange="updatePriorityArea()" class="w-full px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-indigo-900">
                            <option value="National">National / All Areas</option>
                            <optgroup label="Local Councils">
                                <option value="Aberdeen">Aberdeen City</option>
                                <option value="Aberdeenshire">Aberdeenshire</option>
                                <option value="Angus">Angus</option>
                                <option value="Argyll">Argyll & Bute</option>
                                <option value="Clackmannanshire">Clackmannanshire</option>
                                <option value="Dumfries">Dumfries & Galloway</option>
                                <option value="Dundee">Dundee City</option>
                                <option value="East Ayrshire">East Ayrshire</option>
                                <option value="East Dunbartonshire">East Dunbartonshire</option>
                                <option value="East Lothian">East Lothian</option>
                                <option value="East Renfrewshire">East Renfrewshire</option>
                                <option value="Edinburgh">Edinburgh City</option>
                                <option value="Falkirk">Falkirk</option>
                                <option value="Fife">Fife</option>
                                <option value="Glasgow">Glasgow City</option>
                                <option value="Highland">Highland</option>
                                <option value="Inverclyde">Inverclyde</option>
                                <option value="Midlothian">Midlothian</option>
                                <option value="Moray">Moray</option>
                                <option value="Na h-Eileanan Siar">Na h-Eileanan Siar (Western Isles)</option>
                                <option value="North Ayrshire">North Ayrshire</option>
                                <option value="North Lanarkshire">North Lanarkshire</option>
                                <option value="Orkney">Orkney Islands</option>
                                <option value="Perth">Perth & Kinross</option>
                                <option value="Renfrewshire">Renfrewshire</option>
                                <option value="Scottish Borders">Scottish Borders</option>
                                <option value="Shetland">Shetland Islands</option>
                                <option value="South Ayrshire">South Ayrshire</option>
                                <option value="South Lanarkshire">South Lanarkshire</option>
                                <option value="Stirling">Stirling</option>
                                <option value="West Dunbartonshire">West Dunbartonshire</option>
                                <option value="West Lothian">West Lothian</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Deadline</label>
                        <select id="filter-deadline" onchange="applyFilters()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">All Deadlines</option>
                            <option value="urgent">This Week</option>
                            <option value="soon">This Month</option>
                            <option value="quarter">Next 3 Months</option>
                            <option value="rolling">Rolling/Open</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-2 p-2 bg-indigo-50 border border-indigo-100 rounded-lg cursor-pointer w-full hover:bg-indigo-100 transition-colors h-[38px]">
                            <input type="checkbox" id="filter-recommended" onchange="applyFilters()" class="rounded border-indigo-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-[10px] font-bold text-indigo-700 uppercase">For You ‚≠ê</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Opportunities Table -->
            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <h3 class="font-bold text-lg">Verified Opportunities <span id="filtered-count" class="text-slate-400 text-sm font-normal"></span></h3>
                    <button onclick="exportToCSV()" class="px-4 py-2 bg-slate-100 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[1100px]">
                        <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase">
                            <tr>
                                <th class="px-6 py-4 w-10">
                                    <input type="checkbox" id="select-all-opps" onchange="toggleSelectAll()" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                </th>
                                <th class="px-6 py-4">Opportunity</th>
                                <th class="px-6 py-4">Amount</th>
                                <th class="px-6 py-4">Deadline</th>
                                <th class="px-6 py-4">Sectors</th>
                                <th class="px-6 py-4">Quality</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="opp-tbody" class="text-sm divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
                <div id="empty-state" class="p-20 text-center">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                        <i data-lucide="database" class="w-8 h-8"></i>
                    </div>
                    <p class="text-slate-500 font-medium mb-2">No opportunities found</p>
                    <p class="text-slate-400 text-sm">Run a scan to discover verified funding opportunities</p>
                </div>
            </div>
        </section>

        <!-- SHORTLIST SECTION -->
        <section id="shortlist" class="hidden space-y-6">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">My Shortlist</h2>
                    <p class="text-slate-500">Saved funding opportunities for review</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportShortlistCSV()" class="px-4 py-2 bg-slate-100 rounded-lg text-sm font-medium hover:bg-slate-200 transition-all flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export Shortlist
                    </button>
                </div>
            </header>

            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px]">
                        <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase">
                            <tr>
                                <th class="px-6 py-4">Opportunity</th>
                                <th class="px-6 py-4">Amount</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shortlist-tbody" class="text-sm divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
                <div id="shortlist-empty" class="p-20 text-center">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                        <i data-lucide="star" class="w-8 h-8"></i>
                    </div>
                    <p class="text-slate-500 font-medium mb-2">Your shortlist is empty</p>
                    <p class="text-slate-400 text-sm">Star an opportunity to save it here for later</p>
                </div>
            </div>
        </section>

        <!-- BLACKLIST MANAGEMENT SECTION -->
        <section id="blacklist" class="hidden space-y-6">
            <header>
                <h2 class="text-2xl font-bold mb-2">Blacklist Management</h2>
                <p class="text-slate-500">Block specific pages or patterns without removing sources</p>
            </header>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Current Blacklist -->
                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="shield-ban" class="w-5 h-5"></i> Active Blacklist
                    </h3>
                    <div id="blacklist-items" class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="showAddBlacklistModal()" class="w-full px-4 py-2 bg-red-50 text-red-700 rounded-lg font-bold hover:bg-red-100 transition-all">
                        Add Blacklist Pattern
                    </button>
                </div>

                <!-- Blocked Results -->
                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="eye-off" class="w-5 h-5"></i> Recently Blocked
                    </h3>
                    <div id="blocked-results" class="space-y-2 max-h-96 overflow-y-auto text-sm text-slate-600">
                        <p class="text-slate-400 italic">No blocked results yet. Run a scan to see what gets filtered.</p>
                    </div>
                </div>
            </div>

            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                <h4 class="font-bold text-amber-900 mb-2 flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> How Blacklisting Works
                </h4>
                <ul class="text-sm text-amber-900 space-y-1 ml-6 list-disc">
                    <li>Blocks individual pages/URLs without removing entire sources</li>
                    <li>Supports partial matches (e.g., "newsletter" blocks all newsletter pages)</li>
                    <li>Case-insensitive matching</li>
                    <li>Can be restored anytime</li>
                </ul>
            </div>
        </section>

        <!-- SOURCES SECTION -->
        <section id="sources" class="hidden space-y-6">
            <header class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">Premium Funding Sources</h2>
                    <p class="text-slate-500">25+ verified Scottish funding portals</p>
                </div>
                <button onclick="showAddSourceModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add Source
                </button>
            </header>

            <div id="sources-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>
        </section>

        <!-- SCHEDULER, REPORTS, SETTINGS (Same as v3) -->
        <section id="scheduler" class="hidden space-y-6">
            <header>
                <h2 class="text-2xl font-bold mb-2">Automated Scanning</h2>
                <p class="text-slate-500">Configure automatic scans and email notifications</p>
            </header>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5"></i> Scan Schedule
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-2 block">Frequency</label>
                            <select id="scan-frequency" onchange="updateSchedule()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                                <option value="manual">Manual Only</option>
                                <option value="hourly">Every Hour</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div id="schedule-time-picker" class="hidden">
                            <label class="text-sm font-bold text-slate-700 mb-2 block">Time</label>
                            <input type="time" id="scan-time" onchange="updateSchedule()" value="09:00" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-lg">
                            <p class="text-sm text-indigo-900" id="next-scan-text">Next scan: Manual trigger</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="mail" class="w-5 h-5"></i> Email Notifications
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-2 block">Recipients</label>
                            <input type="text" id="email-recipients" placeholder="email@example.com" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-2 block">Trigger</label>
                            <select id="email-frequency" onchange="updateEmailSettings()" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg">
                                <option value="none">No Emails</option>
                                <option value="after-scan">After every scan</option>
                                <option value="new-only">Only if new found</option>
                            </select>
                        </div>
                        <button onclick="sendTestEmail()" class="w-full px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200 transition-all">
                            Send Test Email
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 p-6">
                    <h3 class="font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Advanced Automation
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-2 block">Webhook URL</label>
                            <input type="url" id="webhook-url" onchange="updateWebhookSettings()" placeholder="https://zapier.com/hooks/..." class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm">
                            <p class="text-[10px] text-slate-500 mt-1">Sends new fund data as JSON via POST. Connect to Zapier or Slack.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="webhook-new-only" onchange="updateWebhookSettings()" class="h-4 w-4 rounded border-slate-300 text-indigo-600">
                            <label for="webhook-new-only" class="text-xs font-bold text-slate-600">Only send new opportunities</label>
                        </div>
                        <button onclick="testWebhook()" class="w-full px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200 transition-all">
                            Test Webhook
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="reports" class="hidden space-y-6">
            <header>
                <h2 class="text-2xl font-bold mb-2">System Console</h2>
                <p class="text-slate-500">Real-time scanning logs and activity</p>
            </header>

            <div class="bg-slate-900 rounded-2xl p-6 text-white font-mono text-xs">
                <div id="console-logs" class="space-y-1 h-96 overflow-y-auto log-container">
                    <p class="text-slate-500">> System initialised and ready</p>
                </div>
            </div>

            <button onclick="clearLogs()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200 transition-all">
                Clear Logs
            </button>
        </section>

        <!-- PROFILE SECTION -->
        <section id="profile" class="hidden space-y-6">
            <header>
                <h2 class="text-2xl font-bold mb-2">My Profile</h2>
                <p class="text-slate-500">Manage your organisation details and preferences</p>
            </header>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl border border-slate-200 p-6 space-y-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i data-lucide="building-2" class="w-5 h-5 text-indigo-600"></i> Organisation Details
                    </h3>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Organisation Name</label>
                        <input type="text" id="profile-org-name" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Organisation Type</label>
                        <select id="profile-org-type" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="Charity">Charity / SCIO</option>
                            <option value="Community Group">Unincorporated Community Group</option>
                            <option value="Social Enterprise">Social Enterprise / CIC</option>
                            <option value="Trust">Trust / Foundation</option>
                            <option value="Other">Other Non-Profit</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Your Name</label>
                        <input type="text" id="profile-user-name" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button onclick="updateProfile()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all">
                        Save Profile
                    </button>
                </div>

                <div class="bg-white rounded-2xl border border-slate-200 p-6 space-y-4">
                    <h3 class="font-bold flex items-center gap-2">
                        <i data-lucide="target" class="w-5 h-5 text-purple-600"></i> Funding Interests
                    </h3>
                    <p class="text-xs text-slate-500 italic">Select your primary areas of interest to boost relevant funding in your feed.</p>
                    <div id="profile-interests" class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="play" class="rounded border-slate-300"> <span class="text-xs font-medium">Play & Outdoor</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="youth" class="rounded border-slate-300"> <span class="text-xs font-medium">Youth & Children</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="community" class="rounded border-slate-300"> <span class="text-xs font-medium">Community</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="environment" class="rounded border-slate-300"> <span class="text-xs font-medium">Environment</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="arts" class="rounded border-slate-300"> <span class="text-xs font-medium">Arts & Culture</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="health" class="rounded border-slate-300"> <span class="text-xs font-medium">Health</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="education" class="rounded border-slate-300"> <span class="text-xs font-medium">Education</span>
                        </label>
                        <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" value="sport" class="rounded border-slate-300"> <span class="text-xs font-medium">Sport</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <section id="settings" class="hidden space-y-6">
            <header>
                <h2 class="text-2xl font-bold mb-2">Settings</h2>
                <p class="text-slate-500">Configure application preferences</p>
            </header>

            <div class="bg-white rounded-2xl border border-slate-200 p-6 space-y-6">
                <div>
                    <h3 class="font-bold mb-4">Data Management</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="exportData()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">
                            Export All Data
                        </button>
                        <button onclick="importData()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200">
                            Import Data
                        </button>
                        <button onclick="clearAllData()" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg font-bold hover:bg-red-200">
                            Clear All Data
                        </button>
                    </div>
                </div>

                <div class="border-t border-slate-200 pt-6">
                    <h3 class="font-bold mb-2">About ScotFund Pro</h3>
                    <p class="text-sm text-slate-600">Version 8.0 - Universal Scottish funding intelligence for charities and community groups.</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Modal: Add Blacklist Pattern -->
    <div id="add-blacklist-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold mb-4">Add Blacklist Pattern</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Pattern (URL or keyword)</label>
                    <input type="text" id="new-blacklist-pattern" placeholder="e.g., newsletter, /about, map-of-scotland" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                    <p class="text-xs text-slate-500 mt-1">Blocks any URL containing this text (case-insensitive)</p>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Description (optional)</label>
                    <input type="text" id="new-blacklist-desc" placeholder="e.g., Newsletter signup pages" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="addBlacklistPattern()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700">
                    Add to Blacklist
                </button>
                <button onclick="hideAddBlacklistModal()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Source -->
    <div id="add-source-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold mb-4">Add Funding Source</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Source Name</label>
                    <input type="text" id="new-source-name" placeholder="e.g., Scottish Government Funding" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Website URL</label>
                    <input type="url" id="new-source-url" placeholder="https://example.com/funding" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Keywords (comma-separated)</label>
                    <input type="text" id="new-source-keywords" placeholder="grant, community, scotland" class="w-full px-4 py-2 border border-slate-200 rounded-lg">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="addSource()" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">
                    Add Source
                </button>
                <button onclick="hideAddSourceModal()" class="px-4 py-2 bg-slate-100 rounded-lg font-bold hover:bg-slate-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Opportunity Details -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl">
            <!-- Modal Header -->
            <div class="px-6 pt-6 border-b border-slate-100 flex items-start justify-between shrink-0">
                <div class="flex-1 pr-4 pb-4">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded uppercase tracking-wider">Opportunity Details</span>
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="text-[10px] font-bold text-slate-400 hover:text-indigo-600 uppercase tracking-wider underline">Edit Mode</button>
                    </div>
                    <h3 id="detail-title" class="text-2xl font-bold text-slate-900 leading-tight"></h3>
                    <input type="text" id="edit-title-input" class="hidden w-full text-2xl font-bold text-slate-900 border-b-2 border-indigo-600 outline-none bg-slate-50 px-2 py-1 rounded">
                </div>
                <button onclick="hideDetailsModal()" class="p-2 hover:bg-slate-100 rounded-xl transition-colors shrink-0">
                    <i data-lucide="x" class="w-6 h-6 text-slate-400"></i>
                </button>
            </div>

            <!-- Modal Tabs -->
            <div class="flex border-b border-slate-100 px-6 shrink-0 bg-slate-50/50">
                <button onclick="switchModalTab('overview')" id="tab-overview" class="px-4 py-3 text-[10px] font-bold border-b-2 border-indigo-600 text-indigo-600 transition-all uppercase tracking-widest">Overview</button>
                <button onclick="switchModalTab('guidance')" id="tab-guidance" class="px-4 py-3 text-[10px] font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-900 transition-all uppercase tracking-widest">Guidance</button>
                <button onclick="switchModalTab('matching')" id="tab-matching" class="px-4 py-3 text-[10px] font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-900 transition-all uppercase tracking-widest">Matching</button>
                <button onclick="switchModalTab('notes')" id="tab-notes" class="px-4 py-3 text-[10px] font-bold border-b-2 border-transparent text-slate-500 hover:text-slate-900 transition-all uppercase tracking-widest">My Notes</button>
            </div>

            <!-- Modal Body -->
            <div id="modal-body-container" class="overflow-y-auto flex-1 custom-scrollbar">
                <!-- Overview Tab -->
                <div id="modal-panel-overview" class="modal-panel p-8 space-y-6">
                    <div class="grid md:grid-cols-3 gap-4 border-b border-slate-100 pb-6">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Funder</p>
                        <p id="detail-funder" class="text-sm font-bold text-slate-900"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Amount</p>
                        <p id="detail-amount" class="text-sm font-bold text-green-600"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Deadline</p>
                        <p id="detail-deadline" class="text-sm font-bold text-orange-600"></p>
                        <input type="date" id="edit-deadline-input" class="hidden w-full text-xs border border-slate-200 rounded px-2 py-1 outline-none focus:ring-1 focus:ring-indigo-500 mt-1">
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Sectors</p>
                        <div id="detail-category"></div>
                        <input type="text" id="edit-category-input" class="hidden w-full text-xs border border-slate-200 rounded px-2 py-1 outline-none focus:ring-1 focus:ring-indigo-500 mt-1" placeholder="comma-separated sectors">
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Discovered</p>
                        <p id="detail-date" class="text-sm font-medium text-slate-600"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Quality</p>
                        <p id="detail-quality" class="text-sm font-medium"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Area</p>
                        <p id="detail-geography" class="text-sm font-medium text-slate-700"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Contact</p>
                        <p id="detail-email" class="text-sm font-medium text-indigo-600 truncate"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Status</p>
                        <select id="detail-app-status" class="text-xs font-bold bg-slate-100 rounded px-2 py-1 outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="Not Started">Not Started</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Awarded">Awarded ü•≥</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-1 h-4 bg-indigo-600 rounded-full"></div>
                            <p class="text-xs font-bold text-slate-500 uppercase">Focus & Description</p>
                        </div>
                        <p id="detail-description" class="text-sm text-slate-600 leading-relaxed pl-3"></p>
                    </div>
                </div>
                <div>
                    <p class="text-xs font-bold text-slate-500 uppercase mb-2">Keywords</p>
                    <div id="detail-keywords" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Guidance Tab -->
            <div id="modal-panel-guidance" class="modal-panel p-8 hidden space-y-6">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-1 h-4 bg-purple-600 rounded-full"></div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Eligibility Guidelines</p>
                    </div>
                    <div id="detail-criteria" class="text-sm text-slate-600 leading-relaxed pl-3 italic border-l-2 border-slate-50 ml-0.5"></div>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-1 h-4 bg-green-600 rounded-full"></div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Application Checklist (Extracted)</p>
                    </div>
                    <div id="detail-checklist" class="grid grid-cols-1 gap-2 pl-3"></div>
                </div>
            </div>

            <!-- Matching Tab -->
            <div id="modal-panel-matching" class="modal-panel p-8 hidden space-y-6">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-1 h-4 bg-amber-500 rounded-full"></div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Match Score Breakdown</p>
                    </div>
                    <div id="detail-match-breakdown" class="bg-slate-50 rounded-xl p-4 space-y-3">
                        <p class="text-xs text-slate-500 italic text-center py-4">Direct discovery match based on funder keywords.</p>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="modal-panel-notes" class="modal-panel p-8 hidden space-y-6">
                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-1 h-4 bg-blue-500 rounded-full"></div>
                        <p class="text-xs font-bold text-slate-500 uppercase">Personal Application Notes</p>
                    </div>
                    <textarea id="detail-notes-input" class="w-full h-48 p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all" placeholder="Add your own notes here (saved automatically)..."></textarea>
                    <p class="text-[10px] text-slate-400 mt-2">These notes are stored locally on your device and are persistent.</p>
                </div>
            </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-slate-100 bg-slate-50 shrink-0 rounded-b-2xl">
                <div class="flex flex-wrap gap-2">
                    <a id="detail-link" href="#" target="_blank" class="flex-1 min-w-[200px] text-center px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                        Visit Application Page <i data-lucide="external-link" class="w-4 h-4"></i>
                    </a>
                    <button onclick="shareOpportunity()" class="px-4 py-3 bg-white border border-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-50 transition-all flex items-center justify-center gap-2" title="Share">
                        <i data-lucide="share-2" class="w-4 h-4"></i>
                    </button>
                    <button id="modal-shortlist-btn" onclick="toggleShortlistFromModal()" class="px-4 py-3 bg-white border border-slate-200 text-amber-600 rounded-lg font-bold hover:bg-amber-50 transition-all flex items-center justify-center gap-2" title="Shortlist">
                        <i data-lucide="star" class="w-4 h-4" id="modal-shortlist-icon"></i>
                    </button>
                    <button id="modal-calendar-btn" onclick="exportToICSFromModal()" class="px-4 py-3 bg-white border border-slate-200 text-indigo-600 rounded-lg font-bold hover:bg-indigo-50 transition-all flex items-center justify-center gap-2" title="Add to Calendar">
                        <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                    </button>
                    <button id="save-edit-btn" onclick="saveEdits()" class="hidden px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Save Changes
                    </button>
                    <button onclick="blacklistThisURL()" class="px-4 py-3 bg-white border border-slate-200 text-red-600 rounded-lg font-bold hover:bg-red-50 transition-all flex items-center justify-center gap-2 ml-auto" title="Blacklist">
                        <i data-lucide="shield-ban" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Login / Register -->
    <div id="login-modal" class="fixed inset-0 bg-slate-900/80 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl text-white flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-bold">Welcome to ScotFund Pro</h3>
                <p class="text-slate-500 text-sm mt-2">Universal Scottish Funding Intelligence</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Full Name</label>
                    <input type="text" id="login-name" placeholder="e.g. Jane Doe" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Organisation</label>
                    <input type="text" id="login-org" placeholder="e.g. Glasgow Community Trust" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="pt-4">
                    <button onclick="login()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-100 hover:scale-[1.02] transition-all">
                        Start Using ScotFund Pro
                    </button>
                    <p class="text-[10px] text-center text-slate-400 mt-4">By continuing, you agree to store your data locally on this device.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ENHANCED CONFIGURATION ==========
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest='
        ];

        let currentProxyIndex = 0;
        let currentDetailURL = '';

        // PREMIUM SCOTTISH SOURCES - 25+ verified funding portals
        const DEFAULT_SOURCES = [
            // Major National Funders
            { id: 'tnl', name: 'TNL Community Fund', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes?location=scotland', keywords: ['lottery', 'community', 'scotland', 'grant', 'funding'] },
            { id: 'foundation', name: 'Foundation Scotland', url: 'https://www.foundationscotland.org.uk/apply-for-funding/funding-available', keywords: ['foundation', 'grant', 'scotland', 'charity', 'funding'] },
            { id: 'robertson', name: 'The Robertson Trust', url: 'https://www.therobertsontrust.org.uk/funding/', keywords: ['poverty', 'trauma', 'community', 'scotland', 'grant'] },
            { id: 'corra', name: 'Corra Foundation', url: 'https://www.corra.scot/grants/', keywords: ['community', 'grant', 'scotland', 'change', 'funding'] },
            { id: 'youthlink', name: 'YouthLink Scotland', url: 'https://www.youthlink.scot/funds/', keywords: ['youth', 'young people', 'community', 'play', 'outdoor'] },
            { id: 'inspiring', name: 'Inspiring Scotland', url: 'https://inspiringscotland.org.uk/funds/', keywords: ['community', 'scotland', 'grant', 'funding', 'social'] },
            
            // Government & Public Sector
            { id: 'scotgov', name: 'Scottish Government', url: 'https://www.gov.scot/policies/third-sector/grants-and-funding/', keywords: ['government', 'grant', 'scotland', 'public', 'funding'] },
            { id: 'sportscotland', name: 'sportscotland', url: 'https://sportscotland.org.uk/funding/', keywords: ['sport', 'active', 'physical', 'community', 'facility'] },
            { id: 'creative', name: 'Creative Scotland', url: 'https://www.creativescotland.com/funding', keywords: ['arts', 'creative', 'culture', 'funding', 'scotland'] },
            { id: 'historic', name: 'Historic Environment Scotland', url: 'https://www.historicenvironment.scot/grants-and-funding/', keywords: ['heritage', 'historic', 'building', 'conservation', 'grant'] },
            { id: 'heritage-fund', name: 'National Lottery Heritage Fund', url: 'https://www.heritagefund.org.uk/in-your-area/scotland', keywords: ['heritage', 'culture', 'nature', 'community', 'scotland'] },

            // Banking & Corporate Foundations
            { id: 'bos-foundation', name: 'Bank of Scotland Foundation', url: 'https://bankofscotlandfoundation.org/funding-programmes', keywords: ['charity', 'community', 'scotland', 'grant', 'funding'] },
            { id: 'william-grant', name: 'William Grant Foundation', url: 'https://www.williamgrantfoundation.org.uk/', keywords: ['community', 'scotland', 'culture', 'environment', 'grant'] },
            { id: 'garfield-weston', name: 'Garfield Weston Foundation', url: 'https://garfieldweston.org/', keywords: ['charity', 'grant', 'community', 'arts', 'environment'] },
            { id: 'esmee-fairbairn', name: 'Esm√©e Fairbairn Foundation', url: 'https://esmeefairbairn.org.uk/', keywords: ['environment', 'social', 'creative', 'community', 'grant'] },

            // Third Sector & Support
            { id: 'scvo', name: 'SCVO', url: 'https://scvo.scot/support/funding', keywords: ['voluntary', 'third sector', 'scotland', 'funding', 'charity'] },
            { id: 'firstport', name: 'Firstport', url: 'https://www.firstport.org.uk/funding/', keywords: ['social enterprise', 'entrepreneur', 'scotland', 'startup', 'grant'] },
            { id: 'coss', name: 'Coalition of Care Scotland', url: 'https://www.ccpscotland.org/funding/', keywords: ['care', 'social', 'support', 'community', 'funding'] },
            
            // Health & Wellbeing
            { id: 'nhs-endowments', name: 'NHS Scotland Endowments', url: 'https://www.nhsscotlandendowments.org/', keywords: ['health', 'wellbeing', 'community', 'scotland', 'grant'] },
            { id: 'henry-smith', name: 'Henry Smith Charity', url: 'https://www.henrysmithcharity.org.uk/', keywords: ['poverty', 'disadvantage', 'community', 'grant', 'funding'] },
            
            // Youth & Children
            { id: 'children-in-need', name: 'BBC Children in Need', url: 'https://www.bbcchildreninneed.co.uk/grants/apply/', keywords: ['children', 'youth', 'young people', 'scotland', 'grant'] },
            { id: 'stv-appeal', name: 'STV Children\'s Appeal', url: 'https://www.stv.tv/appeal/grants/', keywords: ['poverty', 'children', 'youth', 'scotland', 'grant'] },
            
            // Specialized & Local
            { id: 'gannochy', name: 'The Gannochy Trust', url: 'https://www.gannochytrust.org.uk/grant-making/', keywords: ['perth', 'youth', 'community', 'scotland', 'grant'] },
            { id: 'paths-for-all', name: 'Paths for All', url: 'https://www.pathsforall.org.uk/community-paths/community-paths-grants', keywords: ['walking', 'active', 'community', 'environment', 'paths'] },
            { id: 'nature-scot', name: 'NatureScot', url: 'https://www.nature.scot/professional-advice/funding', keywords: ['nature', 'environment', 'biodiversity', 'conservation', 'scotland'] },
            { id: 'land-fund', name: 'Scottish Land Fund', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes/scottish-land-fund', keywords: ['land', 'community', 'rural', 'scotland', 'ownership'] },
            { id: 'communityshares', name: 'Community Shares Scotland', url: 'https://communityshares.scot/grants-and-funding/', keywords: ['community', 'shares', 'enterprise', 'scotland', 'funding'] },
            { id: 'paul-hamlyn', name: 'Paul Hamlyn Foundation', url: 'https://www.phf.org.uk/funds/', keywords: ['arts', 'social', 'youth', 'scotland', 'grant'] },
            { id: 'tudor', name: 'Tudor Trust', url: 'https://tudortrust.org.uk/', keywords: ['community', 'voluntary', 'marginalised', 'grant', 'funding'] },
            { id: 'hugh-fraser', name: 'Hugh Fraser Foundation', url: 'https://www.hughfraserfoundation.org.uk/', keywords: ['scotland', 'charity', 'arts', 'health', 'education'] },
            { id: 'souter', name: 'Souter Charitable Trust', url: 'https://www.soutercharitabletrust.org.uk/', keywords: ['scotland', 'poverty', 'health', 'christian', 'grant'] },
            { id: 'wolfson', name: 'Wolfson Foundation', url: 'https://www.wolfson.org.uk/funding/', keywords: ['scotland', 'education', 'science', 'health', 'arts'] },
            { id: 'foyle', name: 'Foyle Foundation', url: 'http://www.foylefoundation.org.uk/', keywords: ['arts', 'learning', 'library', 'scotland', 'grant'] },
            { id: 'wood-foundation', name: 'The Wood Foundation', url: 'https://www.thewoodfoundation.org.uk/', keywords: ['scotland', 'education', 'equity', 'opportunity', 'philanthropy'] },
            { id: 'weir-trust', name: 'The Weir Charitable Trust', url: 'https://weircharitabletrust.com/', keywords: ['scotland', 'community', 'sport', 'health', 'recreation', 'animal'] },
            { id: 'bairdwatson', name: 'Bairdwatson Charitable Trust', url: 'https://www.bairdwatson.org.uk/', keywords: ['scotland', 'employment', 'training', 'vocational', 'charity'] },
            { id: 'volant', name: 'Volant Trust', url: 'https://www.volanttrust.com/', keywords: ['scotland', 'poverty', 'social', 'vulnerable', 'women', 'children'] },
            { id: 'merchants-house', name: 'The Merchants House of Glasgow', url: 'https://www.merchantshouse.org.uk/grants', keywords: ['glasgow', 'community', 'charity', 'poverty', 'elderly'] },
            { id: 'trades-house', name: 'The Trades House of Glasgow', url: 'https://www.tradeshouse.org.uk/', keywords: ['glasgow', 'charity', 'craft', 'community', 'funding'] },
            { id: 'mickel-fund', name: 'The Mickel Fund', url: 'https://www.mickelfund.org.uk/', keywords: ['scotland', 'poverty', 'health', 'education', 'arts'] },
            { id: 'miller-foundation', name: 'The Miller Foundation', url: 'https://www.millerfoundation.org.uk/', keywords: ['scotland', 'community', 'health', 'education', 'poverty'] },
            { id: 'macrobert-trust', name: 'The MacRobert Trust', url: 'https://www.themacroberttrust.org.uk/', keywords: ['scotland', 'military', 'rural', 'community', 'arts'] },
            { id: 'rank-foundation', name: 'The Rank Foundation', url: 'https://rankfoundation.com/', keywords: ['scotland', 'youth', 'community', 'leadership', 'social'] },
            { id: 'faith-in-community', name: 'Faith in Community Scotland', url: 'https://www.faithincommunityscotland.org/', keywords: ['scotland', 'faith', 'poverty', 'community', 'social'] },
            { id: 'stafford-trust', name: 'The Stafford Trust', url: 'https://www.staffordtrust.org.uk/apply-for-a-grant/', keywords: ['scotland', 'charity', 'animal', 'child', 'medical', 'community'] },
            { id: 'agnes-hunter', name: 'Agnes Hunter Trust', url: 'https://www.agneshunter.org.uk/', keywords: ['scotland', 'disability', 'health', 'social', 'welfare'] },
            { id: 'jth-trust', name: 'JTH Charitable Trust', url: 'http://www.jthcharitabletrust.org/', keywords: ['scotland', 'community', 'charity', 'arts', 'education'] },
            { id: 'templeton', name: 'Templeton Goodwill Trust', url: 'https://www.templetongoodwill.org.uk/', keywords: ['scotland', 'poverty', 'social', 'community', 'christian'] },
            { id: 'baird-trust', name: 'The Baird Trust', url: 'https://www.bairdtrust.org.uk/', keywords: ['scotland', 'church', 'community', 'social', 'welfare'] },
            { id: 'moncur-trust', name: 'Alexander Moncur Trust', url: 'https://www.moncurtrust.org.uk/', keywords: ['dundee', 'scotland', 'charity', 'community', 'arts'] },
            { id: 'leng-trust', name: 'Leng Charitable Trust', url: 'https://www.lengcharitabletrust.org.uk/', keywords: ['dundee', 'scotland', 'charity', 'community', 'social'] },
            { id: 'tay-trust', name: 'Tay Charitable Trust', url: 'https://www.taycharitabletrust.org.uk/', keywords: ['dundee', 'scotland', 'environment', 'community', 'arts'] },
            { id: 'misses-barrie', name: 'Misses Barrie Charitable Trust', url: 'https://www.missesbarrie.org.uk/', keywords: ['scotland', 'charity', 'community', 'education', 'health'] },
            { id: 'russell-trust', name: 'The Russell Trust', url: 'https://www.russelltrust.org.uk/', keywords: ['fife', 'scotland', 'charity', 'community', 'arts', 'education'] },
            { id: 'martin-connell', name: 'Martin Connell Charitable Trust', url: 'https://www.martinconnelltrust.org.uk/', keywords: ['scotland', 'poverty', 'youth', 'disability', 'community'] },
            { id: 'northwood', name: 'The Northwood Charitable Trust', url: 'https://www.northwoodtrust.com/', keywords: ['dundee', 'scotland', 'poverty', 'social', 'community'] },
            { id: 'ryvoan-trust', name: 'The Ryvoan Trust', url: 'https://www.ryvoantrust.org.uk/', keywords: ['scotland', 'disability', 'welfare', 'social', 'community'] },
            { id: 'sis', name: 'Social Investment Scotland', url: 'https://www.socialinvestmentscotland.com/', keywords: ['scotland', 'social enterprise', 'investment', 'loan', 'finance'] },
            { id: 'cash-for-kids', name: 'Cash for Kids (Scotland)', url: 'https://www.cashforkids.org.uk/grants', keywords: ['scotland', 'children', 'poverty', 'disability', 'community'] },
            { id: 'guildry-stirling', name: 'The Guildry of Stirling', url: 'https://www.guildryofstirling.org.uk/grants/', keywords: ['stirling', 'scotland', 'community', 'charity', 'education'] },
            { id: 'seven-trades', name: 'Seven Trades of Aberdeen', url: 'https://www.seventradesofaberdeen.co.uk/charity/', keywords: ['aberdeen', 'scotland', 'charity', 'community', 'craft'] },
            { id: 'weavers-glasgow', name: 'Incorporation of Weavers', url: 'https://www.weavers-of-glasgow.com/grants/', keywords: ['glasgow', 'scotland', 'charity', 'community', 'education'] },
            { id: 'gardeners-glasgow', name: 'Incorporation of Gardeners', url: 'https://www.gardenersofglasgow.org.uk/charity/', keywords: ['glasgow', 'scotland', 'charity', 'community', 'horticulture'] },
            { id: 'shetland-trust', name: 'Shetland Charitable Trust', url: 'https://www.shetlandcharitytrust.co.uk/', keywords: ['shetland', 'scotland', 'community', 'social', 'arts'] },
            { id: 'orkney-trust', name: 'Orkney Charitable Trust', url: 'https://www.orkneycharitabletrust.org.uk/', keywords: ['orkney', 'scotland', 'children', 'poverty', 'community'] },
            { id: 'western-isles', name: 'Western Isles Community Trust', url: 'https://www.wict.org.uk/', keywords: ['western isles', 'scotland', 'community', 'rural', 'development'] },
            { id: 'ahf', name: 'Architectural Heritage Fund', url: 'https://ahfund.org.uk/scotland/', keywords: ['heritage', 'historic', 'building', 'community', 'scotland'] },
            { id: 'sose', name: 'South of Scotland Enterprise', url: 'https://www.southofscotlandenterprise.com/funding', keywords: ['business', 'community', 'south of scotland', 'grant', 'funding'] },
            { id: 'hie', name: 'Highlands and Islands Enterprise', url: 'https://www.hie.co.uk/funding/', keywords: ['business', 'community', 'highlands', 'islands', 'grant'] },
            { id: 'mgs', name: 'Museums Galleries Scotland', url: 'https://www.museumsgalleriesscotland.org.uk/funding/', keywords: ['museum', 'gallery', 'heritage', 'culture', 'grant'] },
            { id: 'cycling-scot', name: 'Cycling Scotland', url: 'https://www.cycling.scot/funding', keywords: ['cycling', 'active travel', 'community', 'grant', 'scotland'] },
            { id: 'sustrans', name: 'Sustrans Scotland', url: 'https://www.sustrans.org.uk/about-us/our-work-in-scotland/', keywords: ['walking', 'cycling', 'active travel', 'community', 'scotland'] },
            { id: 'baillie-gifford', name: 'Baillie Gifford Philanthropy', url: 'https://www.bailliegifford.com/en/uk/about-us/philanthropy/', keywords: ['community', 'arts', 'education', 'scotland', 'grant'] },
            { id: 'est-scot', name: 'Energy Saving Trust Scotland', url: 'https://energysavingtrust.org.uk/scotland/grants-and-loans/', keywords: ['energy', 'climate', 'sustainability', 'scotland', 'grant'] },
            { id: 'glasgow-city', name: 'Glasgow City Council Grants', url: 'https://www.glasgow.gov.uk/index.aspx?articleid=15895', keywords: ['glasgow', 'community', 'grant', 'funding', 'local'] },
            { id: 'edinburgh-council', name: 'City of Edinburgh Council Grants', url: 'https://www.edinburgh.gov.uk/grants', keywords: ['edinburgh', 'community', 'grant', 'funding', 'local'] },
            { id: 'fife-council', name: 'Fife Council Funding', url: 'https://www.fife.gov.uk/kb/docs/articles/community-life2/funding', keywords: ['fife', 'community', 'grant', 'funding', 'local'] },
            { id: 'aberdeen-city', name: 'Aberdeen City Council Funding', url: 'https://www.aberdeencity.gov.uk/services/strategy-performance-and-statistics/city-funding', keywords: ['aberdeen', 'community', 'grant', 'funding', 'local'] },
            { id: 'film-hub-scot', name: 'Film Hub Scotland', url: 'https://www.filmhubscotland.com/funding/', keywords: ['film', 'cinema', 'culture', 'scotland', 'grant'] },
            { id: 'youth-scotland', name: 'Youth Scotland', url: 'https://www.youthscotland.org.uk/funding/', keywords: ['youth', 'young people', 'community', 'scotland', 'grant'] },
            { id: 'arnold-clark', name: 'Arnold Clark Community Fund', url: 'https://www.arnoldclark.com/community-fund', keywords: ['community', 'scotland', 'grant', 'funding'] },
            { id: 'postcode-trust', name: 'People\'s Postcode Trust', url: 'https://www.postcodetrust.org.uk/apply-for-funding/', keywords: ['community', 'scotland', 'grant', 'funding'] },
            { id: 'sse-renewables', name: 'SSE Renewables Community Fund', url: 'https://www.sserenewables.com/communities/community-funds/', keywords: ['community', 'scotland', 'environment', 'grant'] },
            { id: 'morrisons-foundation', name: 'Morrisons Foundation', url: 'https://www.morrisonsfoundation.com/grant-funding-application-form/', keywords: ['charity', 'community', 'scotland', 'grant'] },
            { id: 'bq-foundation', name: 'B&Q Foundation', url: 'https://bqfoundation.org.uk/apply-for-funding/', keywords: ['community', 'home', 'housing', 'scotland', 'grant'] },
            { id: 'tesco-starts', name: 'Tesco Stronger Starts', url: 'https://tescostrongerstarts.org.uk/', keywords: ['community', 'youth', 'children', 'scotland', 'grant'] },
            { id: 'scotmid', name: 'Scotmid Community Grants', url: 'https://scotmid.coop/community-and-charity/supporting-local-communities/community-grants/', keywords: ['community', 'local', 'scotland', 'grant'] },
            { id: 'coop-foundation', name: 'Co-op Foundation', url: 'https://www.coopfoundation.org.uk/apply/', keywords: ['community', 'youth', 'scotland', 'grant'] },
            { id: 'impact-funding', name: 'Impact Funding Partners', url: 'https://impactfundingpartners.com/funds', keywords: ['scotland', 'community', 'equality', 'wellbeing', 'grant'] },
            { id: 'young-start', name: 'Young Start (TNL)', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes/young-start', keywords: ['youth', 'scotland', 'young people', 'community', 'grant'] },
            { id: 'awards-for-all', name: 'National Lottery Awards for All Scotland', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes/national-lottery-awards-for-all-scotland', keywords: ['community', 'scotland', 'grant', 'small', 'funding'] },
            { id: 'community-led', name: 'Community-Led (TNL)', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes/community-led', keywords: ['community', 'scotland', 'grant', 'disadvantage', 'funding'] },
            { id: 'cost-of-living', name: 'Cost of Living Support Scotland (TNL)', url: 'https://www.tnlcommunityfund.org.uk/funding/programmes/cost-of-living-support-scotland', keywords: ['poverty', 'scotland', 'crisis', 'community', 'grant'] },
            { id: 'clothworkers', name: 'The Clothworkers\' Foundation', url: 'https://www.clothworkersfoundation.org.uk/', keywords: ['charity', 'capital', 'scotland', 'disadvantage', 'grant'] },
            { id: 'bernard-sunley', name: 'The Bernard Sunley Foundation', url: 'https://bernardsunley.org/', keywords: ['charity', 'capital', 'scotland', 'community', 'grant'] },
            { id: 'rayne-foundation', name: 'The Rayne Foundation', url: 'https://www.raynefoundation.org.uk/', keywords: ['charity', 'social', 'scotland', 'arts', 'grant'] },
            { id: 'schroder-charity', name: 'The Schroder Charity Trust', url: 'https://schrodercharitytrust.org/', keywords: ['charity', 'scotland', 'culture', 'environment', 'grant'] },
            { id: 'trusthouse', name: 'The Trusthouse Charitable Foundation', url: 'https://www.trusthousecharitablefoundation.org.uk/', keywords: ['community', 'scotland', 'deprived', 'grant', 'funding'] },
            { id: 'screen-scotland', name: 'Screen Scotland', url: 'https://www.screen.scot/funding-and-support', keywords: ['film', 'screen', 'culture', 'scotland', 'grant'] },
            { id: 'robertson-small', name: 'The Robertson Trust - Small Grants', url: 'https://www.therobertsontrust.org.uk/funding/small-grants/', keywords: ['poverty', 'trauma', 'scotland', 'community', 'grant'] },
            { id: 'robertson-large', name: 'The Robertson Trust - Large Grants', url: 'https://www.therobertsontrust.org.uk/funding/large-grants/', keywords: ['poverty', 'trauma', 'scotland', 'community', 'grant'] },
            { id: 'coalfields-scotland', name: 'The Coalfields Regeneration Trust Scotland', url: 'https://www.coalfields-regen.org.uk/scotland', keywords: ['coalfields', 'community', 'scotland', 'regeneration', 'grant'] },
            { id: 'funding-scotland', name: 'Funding Scotland (SCVO)', url: 'https://funding.scot/', keywords: ['scotland', 'charity', 'community', 'funding', 'search'] },
            { id: 'zero-waste', name: 'Zero Waste Scotland', url: 'https://www.zerowastescotland.org.uk/funding', keywords: ['environment', 'circular economy', 'waste', 'recycling', 'grant'] },
            { id: 'local-energy', name: 'Local Energy Scotland', url: 'https://localenergy.scot/funding/', keywords: ['energy', 'renewables', 'community', 'cares', 'climate'] },
            { id: 'dtas', name: 'DTAS', url: 'https://dtascot.org.uk/funding', keywords: ['development trust', 'community', 'land', 'assets', 'scotland'] },
            { id: 'gcvs', name: 'GCVS (Glasgow TSI)', url: 'https://www.gcvs.org.uk/funding/', keywords: ['glasgow', 'voluntary', 'charity', 'funding', 'support'] },
            { id: 'evoc', name: 'EVOC (Edinburgh TSI)', url: 'https://www.evoc.org.uk/funding/', keywords: ['edinburgh', 'voluntary', 'charity', 'funding', 'support'] },
            { id: 'falkirk-tsi', name: 'CVS Falkirk', url: 'https://www.cvsfalkirk.org.uk/funding/', keywords: ['falkirk', 'voluntary', 'community', 'grant', 'funding'] },
            { id: 'fife-voluntary', name: 'Fife Voluntary Action', url: 'https://www.fva.org/funding.asp', keywords: ['fife', 'voluntary', 'charity', 'funding', 'grant'] },
            { id: 'aberdeen-tsi', name: 'ACVO (Aberdeen TSI)', url: 'https://acvo.org.uk/funding/', keywords: ['aberdeen', 'voluntary', 'charity', 'funding', 'support'] },
            { id: 'scot-ent', name: 'Scottish Enterprise', url: 'https://www.scottish-enterprise.com/support-for-businesses/funding-and-grants', keywords: ['business', 'innovation', 'growth', 'scotland', 'grant'] },
            { id: 'bus-gateway', name: 'Business Gateway', url: 'https://www.bgateway.com/resources/funding', keywords: ['business', 'startup', 'funding', 'scotland', 'advice'] },
            { id: 'social-ent-scot', name: 'Social Enterprise Scotland', url: 'https://socialenterprise.scot/funding/', keywords: ['social enterprise', 'cic', 'scio', 'impact', 'funding'] }
        ];

        // ENHANCED BLACKLIST - Comprehensive pattern matching
        const DEFAULT_BLACKLIST = [
            // Charity Registers & Databases
            { pattern: 'oscr.org.uk', description: 'Scottish Charity Register', active: true },
            { pattern: '/charity-details', description: 'Charity detail pages', active: true },
            { pattern: '/search-the-register', description: 'Charity search results', active: true },
            { pattern: 'companies-house', description: 'Companies House', active: true },
            
            // Generic Pages
            { pattern: '/about', description: 'About pages', active: true },
            { pattern: '/about-us', description: 'About us pages', active: true },
            { pattern: '/contact', description: 'Contact pages', active: true },
            { pattern: '/news', description: 'News articles', active: true },
            { pattern: '/blog', description: 'Blog posts', active: true },
            { pattern: '/events', description: 'Events pages', active: true },
            { pattern: '/privacy', description: 'Privacy policies', active: true },
            { pattern: '/terms', description: 'Terms & conditions', active: true },
            { pattern: '/cookie', description: 'Cookie policies', active: true },
            
            // Newsletters & Signup
            { pattern: 'newsletter', description: 'Newsletter pages', active: true },
            { pattern: '/sign-up', description: 'Signup pages', active: true },
            { pattern: '/subscribe', description: 'Subscribe pages', active: true },
            { pattern: '/join', description: 'Join/membership pages', active: true },
            
            // Maps & Location Finders
            { pattern: 'map-of-scotland', description: 'Map pages', active: true },
            { pattern: '/map', description: 'Map/location pages', active: true },
            { pattern: "where-we've-funded", description: 'Funded project maps', active: true },
            { pattern: '/funded-projects', description: 'Past funded projects', active: true },
            
            // Social Media & External
            { pattern: 'facebook.com', description: 'Facebook', active: true },
            { pattern: 'twitter.com', description: 'Twitter', active: true },
            { pattern: 'linkedin.com', description: 'LinkedIn', active: true },
            { pattern: 'instagram.com', description: 'Instagram', active: true },
            { pattern: 'youtube.com', description: 'YouTube', active: true },
            
            // Search & Navigation
            { pattern: '/search?', description: 'Search results', active: true },
            { pattern: '/tag/', description: 'Tag pages', active: true },
            { pattern: '/category/', description: 'Category archives', active: true },
            { pattern: '/author/', description: 'Author pages', active: true },
            
            // Irrelevant System Pages
            { pattern: '/login', description: 'Login pages', active: true },
            { pattern: '/register', description: 'Registration pages', active: true },
            { pattern: '/cgi-bin/', description: 'System scripts', active: true },
            { pattern: '/wp-includes/', description: 'WordPress system', active: true },
            { pattern: '/node_modules/', description: 'Code libraries', active: true },
            { pattern: '/cart', description: 'Shopping cart', active: true },
            { pattern: '/checkout', description: 'Checkout pages', active: true },
            { pattern: '/my-account', description: 'User accounts', active: true },
            { pattern: '/careers', description: 'Job openings', active: true },
            { pattern: '/jobs', description: 'Job openings', active: true },
            { pattern: '/vacancy', description: 'Vacancies', active: true },
            { pattern: '/vacancies', description: 'Vacancies', active: true },
            { pattern: '/donate', description: 'Donation pages', active: true },
            { pattern: '/accessibility', description: 'Accessibility', active: true },
            { pattern: '/sitemap', description: 'Sitemap', active: true },
            { pattern: '/help', description: 'Help pages', active: true },
            { pattern: '/faq', description: 'FAQ', active: true },
            { pattern: '/faqs', description: 'FAQ', active: true },
            { pattern: '/legal', description: 'Legal pages', active: true },
            { pattern: '/complaints', description: 'Complaints', active: true },

            // File Extensions & Media
            { pattern: '.jpg', description: 'Images', active: true },
            { pattern: '.png', description: 'Images', active: true },
            { pattern: '.jpeg', description: 'Images', active: true },
            { pattern: '.gif', description: 'Images', active: true },
            { pattern: '.svg', description: 'Images', active: true },
            { pattern: '.webp', description: 'Images', active: true },
            { pattern: '.mp4', description: 'Video', active: true },
            { pattern: '.mp3', description: 'Audio', active: true },
            { pattern: '.zip', description: 'Archives', active: true },
            { pattern: '.gz', description: 'Archives', active: true },
            { pattern: '.exe', description: 'Executables', active: true },
            { pattern: '.dmg', description: 'Executables', active: true },
            { pattern: '.bmp', description: 'Images', active: true },
            { pattern: '.ico', description: 'Icons', active: true },
            { pattern: '.woff', description: 'Fonts', active: true },
            { pattern: '.ttf', description: 'Fonts', active: true },
            { pattern: '.wav', description: 'Audio', active: true },
            { pattern: '.mov', description: 'Video', active: true },
            { pattern: '.ogg', description: 'Audio', active: true },
            { pattern: '.m4v', description: 'Video', active: true },
            { pattern: '.webm', description: 'Video', active: true },
            { pattern: '.tif', description: 'Images', active: true },
            { pattern: '.tiff', description: 'Images', active: true },
            { pattern: '.heic', description: 'Images', active: true },
            { pattern: '.raw', description: 'Images', active: true },
            { pattern: '.eps', description: 'Vector images', active: true },
            { pattern: '.ai', description: 'Adobe Illustrator', active: true },
            { pattern: '.psd', description: 'Photoshop files', active: true },
            { pattern: 'press-release', description: 'News/Press', active: true },
            { pattern: 'job-opportunities', description: 'Job listings', active: true },
            { pattern: 'working-for-us', description: 'Job listings', active: true },
            { pattern: 'annual-report', description: 'Corporate reports', active: true },
            { pattern: 'governance', description: 'Governance pages', active: true },
            { pattern: 'transparency', description: 'Corporate pages', active: true },

            // User-Added Patterns (examples)
            { pattern: 'dormant-assets', description: 'Dormant Assets pages', active: true },
            { pattern: 'fairer-life-chances', description: 'Past programme names', active: true },
            { pattern: 'people-and-places', description: 'Closed programmes', active: true }
        ];

        let state = {
            opportunities: JSON.parse(localStorage.getItem('scotfund_opportunities')) || [],
            selectedIds: new Set(),
            shortlist: JSON.parse(localStorage.getItem('scotfund_shortlist')) || [],
            blockedResults: [],
            sources: JSON.parse(localStorage.getItem('scotfund_sources')) || [...DEFAULT_SOURCES],
            blacklist: JSON.parse(localStorage.getItem('scotfund_blacklist')) || [...DEFAULT_BLACKLIST],
            isScanning: false,
            schedule: JSON.parse(localStorage.getItem('scotfund_schedule')) || { frequency: 'manual', time: '09:00' },
            email: JSON.parse(localStorage.getItem('scotfund_email')) || { recipients: '', frequency: 'none' },
            user: JSON.parse(localStorage.getItem('scotfund_user')) || null,
            settings: JSON.parse(localStorage.getItem('scotfund_settings')) || { priorityArea: 'National', webhookUrl: '', webhookNewOnly: false },
            lastScan: localStorage.getItem('scotfund_lastScan') || null,
            scanInterval: null
        };

        // ========== INITIALISATION ==========
        function init() {
            lucide.createIcons();
            migrateData();
            syncUIWithState();
            syncUserDisplay();
            updateStats();
            renderDashboard();
            renderShortlist();
            renderSources();
            renderBlacklist();
            loadScheduleSettings();
            showSection('dashboard');
            initScheduler();
        }

        function login() {
            const name = document.getElementById('login-name').value.trim();
            const org = document.getElementById('login-org').value.trim();

            if (!name || !org) {
                alert('Please fill in your name and organisation');
                return;
            }

            state.user = {
                name,
                org,
                orgType: 'Charity',
                interests: []
            };

            saveData();
            document.getElementById('login-modal').classList.add('hidden');
            syncUserDisplay();
            log(`‚úì Logged in as ${name} (${org})`, 'success');
        }

        function logout() {
            if (!confirm('Are you sure you want to logout? Your saved data will remain on this device.')) return;
            state.user = null;
            saveData();
            location.reload();
        }

        function syncUserDisplay() {
            const display = document.getElementById('user-display');
            const loginModal = document.getElementById('login-modal');

            if (state.user) {
                display.classList.remove('hidden');
                document.getElementById('user-name-display').textContent = state.user.name;
                document.getElementById('user-org-display').textContent = state.user.org;

                // Sync Profile inputs
                document.getElementById('profile-org-name').value = state.user.org;
                document.getElementById('profile-org-type').value = state.user.orgType || 'Charity';
                document.getElementById('profile-user-name').value = state.user.name;

                // Sync interests
                if (state.user.interests) {
                    document.querySelectorAll('#profile-interests input').forEach(cb => {
                        cb.checked = state.user.interests.includes(cb.value);
                    });
                }
            } else {
                display.classList.add('hidden');
                loginModal.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function updateProfile() {
            const org = document.getElementById('profile-org-name').value.trim();
            const type = document.getElementById('profile-org-type').value;
            const name = document.getElementById('profile-user-name').value.trim();

            const interests = [];
            document.querySelectorAll('#profile-interests input:checked').forEach(cb => interests.push(cb.value));

            if (!org || !name) {
                alert('Name and Organisation are required');
                return;
            }

            state.user = {
                name,
                org,
                orgType: type,
                interests
            };

            saveData();
            syncUserDisplay();
            log('‚úì Profile updated successfully', 'success');
            applyFilters(); // Re-rank based on new interests
        }

        function toggleSelection(id) {
            if (state.selectedIds.has(id)) state.selectedIds.delete(id);
            else state.selectedIds.add(id);
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all-opps').checked;
            const filtered = applyFilters(true);
            if (selectAll) {
                filtered.forEach(o => state.selectedIds.add(o.id));
            } else {
                filtered.forEach(o => state.selectedIds.delete(o.id));
            }
            renderDashboard();
        }

        function migrateData() {
            let migrated = false;
            state.opportunities = state.opportunities.map(o => {
                if (o.dateAdded && !o.dateDiscovered) {
                    o.dateDiscovered = o.dateAdded;
                    delete o.dateAdded;
                    migrated = true;
                }
                return o;
            });
            if (migrated) saveData();
        }

        function syncUIWithState() {
            // Sync UI with settings
            if (state.settings.priorityArea) {
                const select = document.getElementById('priority-area');
                if (select) select.value = state.settings.priorityArea;
            }
            if (state.settings.webhookUrl) {
                const input = document.getElementById('webhook-url');
                if (input) input.value = state.settings.webhookUrl;
            }
            if (state.settings.webhookNewOnly) {
                const checkbox = document.getElementById('webhook-new-only');
                if (checkbox) checkbox.checked = state.settings.webhookNewOnly;
            }
        }

        function saveData() {
            localStorage.setItem('scotfund_opportunities', JSON.stringify(state.opportunities));
            localStorage.setItem('scotfund_shortlist', JSON.stringify(state.shortlist));
            localStorage.setItem('scotfund_sources', JSON.stringify(state.sources));
            localStorage.setItem('scotfund_blacklist', JSON.stringify(state.blacklist));
            localStorage.setItem('scotfund_schedule', JSON.stringify(state.schedule));
            localStorage.setItem('scotfund_email', JSON.stringify(state.email));
            localStorage.setItem('scotfund_user', JSON.stringify(state.user));
            localStorage.setItem('scotfund_lastScan', state.lastScan);
            localStorage.setItem('scotfund_settings', JSON.stringify(state.settings));
        }

        // ========== UI CONTROLS ==========
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.toggle('bg-indigo-50', l.dataset.id === id);
                l.classList.toggle('text-indigo-600', l.dataset.id === id);
            });

            if (id === 'shortlist') renderShortlist();
            if (id === 'dashboard') renderDashboard();

            if (window.innerWidth < 1024) toggleSidebar();
            lucide.createIcons();
        }

        function switchModalTab(panelId) {
            // Update buttons
            ['overview', 'guidance', 'matching', 'notes'].forEach(id => {
                const btn = document.getElementById(`tab-${id}`);
                if (!btn) return;
                btn.classList.remove('border-indigo-600', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-slate-500');
            });
            const activeBtn = document.getElementById(`tab-${panelId}`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-slate-500');
                activeBtn.classList.add('border-indigo-600', 'text-indigo-600');
            }

            // Show panel
            document.querySelectorAll('.modal-panel').forEach(panel => panel.classList.add('hidden'));
            const targetPanel = document.getElementById(`modal-panel-${panelId}`);
            if (targetPanel) targetPanel.classList.remove('hidden');

            // Reset scroll
            const container = document.getElementById('modal-body-container');
            if (container) container.scrollTop = 0;
        }

        function log(msg, type = 'info') {
            const container = document.getElementById('console-logs');
            const p = document.createElement('p');
            const colours = { info: 'text-slate-400', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400' };
            p.className = colours[type];
            p.innerText = `> [${new Date().toLocaleTimeString('en-GB')}] ${msg}`;
            container.appendChild(p);
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '<p class="text-slate-500">> Logs cleared</p>';
        }

        // ========== ULTIMATE SCANNING ENGINE ==========
        async function runUltimateScan(isAutomated = false) {
            if (state.isScanning) return;
            
            // If automated and already ran this minute, skip to prevent double triggers
            const now = new Date();
            const minuteKey = now.getHours() + ':' + now.getMinutes();
            if (isAutomated && state.lastAutomatedMinute === minuteKey) return;
            if (isAutomated) state.lastAutomatedMinute = minuteKey;

            toggleScanUI(true);
            updateScanProgress('Initialising scan...', 5);

            // Map existing opportunities by URL for smart merging
            const existingMap = new Map(state.opportunities.map(o => [o.url, o]));
            state.blockedResults = [];
            
            log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", 'info');
            log("ULTIMATE SCAN INITIATED", 'success');
            log("Using Advanced Pattern Matching & Intelligent Filtering", 'info');
            log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", 'info');

            for (let i = 0; i < state.sources.length; i++) {
                const source = state.sources[i];
                const progress = Math.round(5 + ((i / state.sources.length) * 90));
                updateScanProgress(`Scanning ${i + 1}/${state.sources.length}: ${source.name}`, progress);
                log(`‚Üí Scanning: ${source.name}`, 'info');
                
                try {
                    const html = await fetchWithFallback(source.url);
                    const doc = new DOMParser().parseFromString(html, 'text/html');
                    
                    log(`‚úì Page loaded (${(html.length / 1024).toFixed(1)} KB)`, 'success');
                    updateScanProgress(`Analysing ${source.name}...`);
                    
                    const newOpps = await ultimateParse(doc, source, html);
                    
                    if (newOpps.length > 0) {
                        newOpps.forEach(opp => {
                            if (existingMap.has(opp.url)) {
                                const existing = existingMap.get(opp.url);
                                // Merge - new scan data takes precedence but keep discovery date
                                opp.dateDiscovered = existing.dateDiscovered || new Date().toISOString();
                                existingMap.set(opp.url, opp);
                            } else {
                                opp.dateDiscovered = new Date().toISOString();
                                existingMap.set(opp.url, opp);
                            }
                        });
                        log(`‚úì Verified ${newOpps.length} genuine opportunities`, 'success');
                    } else {
                        log(`‚ö† No matches after filtering`, 'warn');
                    }
                    
                } catch (err) {
                    log(`‚úó Error: ${err.message}`, 'error');
                }
                
                await sleep(800);
            }

            updateScanProgress('Finalising results...', 98);
            state.opportunities = Array.from(existingMap.values());
            state.lastScan = new Date().toISOString();
            saveData();
            
            log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", 'info');
            log(`SCAN COMPLETE: ${state.opportunities.length} verified opportunities`, 'success');
            log(`Blocked ${state.blockedResults.length} irrelevant pages`, 'warn');
            log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê", 'info');

            renderDashboard();
            renderBlockedResults();
            updateStats();
            toggleScanUI(false);
            
            // Handle Email Reporting
            if (state.email.frequency !== 'none') {
                const hasNew = state.opportunities.some(o => {
                    const diff = new Date() - new Date(o.dateDiscovered);
                    return diff < 3600000; // Found in last hour
                });

                if (state.email.frequency === 'after-scan' || (state.email.frequency === 'new-only' && hasNew)) {
                    log('üìß Sending automated email report...', 'info');
                    sendEmailNotification();
                }
            }

            // Trigger Webhook
            triggerWebhook(state.opportunities);
        }

        async function triggerWebhook(data) {
            try {
                if (!state.settings?.webhookUrl) return;

                let payload = [...data];
                if (state.settings.webhookNewOnly) {
                    const oneDayAgo = new Date();
                    oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                    payload = payload.filter(o => new Date(o.dateDiscovered) > oneDayAgo);
                }

                if (payload.length === 0 && state.settings.webhookNewOnly) return;

                await fetch(state.settings.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'ScotFund Pro v8.0',
                        timestamp: new Date().toISOString(),
                        count: payload.length,
                        opportunities: payload
                    })
                });
                log('‚úì Webhook triggered successfully', 'success');
            } catch (err) {
                log(`‚úó Webhook failed: ${err.message}`, 'error');
            }
        }

        function updateScanProgress(message, progressPercent = null) {
            const btnText = document.getElementById('btn-text');
            if (btnText) {
                btnText.textContent = message;
            }

            const progressBar = document.getElementById('global-progress-bar');
            if (progressBar && progressPercent !== null) {
                progressBar.style.width = `${progressPercent}%`;
            }
        }

        async function fetchWithFallback(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const proxy = PROXIES[currentProxyIndex];
                    const response = await fetch(proxy + encodeURIComponent(url), {
                        signal: AbortSignal.timeout(15000)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const text = await response.text();
                    if (!text.includes('<html') && !text.includes('<body')) throw new Error('Invalid HTML');
                    
                    return text;
                } catch (err) {
                    currentProxyIndex = (currentProxyIndex + 1) % PROXIES.length;
                    if (i === maxRetries - 1) throw err;
                    await sleep(1000);
                }
            }
        }

        // ========== ULTIMATE PARSING WITH WHITELIST PATTERN MATCHING ==========
        async function ultimateParse(doc, source, html) {
            const results = [];
            const seen = new Set();
            
            const links = Array.from(doc.querySelectorAll('a[href]'));
            
            log(`  Analysing ${links.length} links with whitelist patterns...`, 'info');
            
            // WHITELIST PATTERNS - Only allow these types of links
            const whitelistPatterns = [
                /apply/i, /application/i, /guidance/i, /criteria/i, /eligibility/i,
                /fund/i, /grant/i, /programme/i, /scheme/i, /award/i, /bursary/i,
                /how-to/i, /information/i, /details/i, /guidelines/i, /prospectus/i,
                /\.pdf$/i, /download/i, /form/i
            ];
            
            let whitelistPassed = 0;
            let blacklistBlocked = 0;
            
            for (const link of links) {
                const href = link.getAttribute('href');
                let text = link.textContent.trim();
                const fullUrl = resolveUrl(source.url, href);
                
                // Smarter title extraction
                const ariaLabel = link.getAttribute('aria-label');
                const linkTitle = link.getAttribute('title');

                if (/^(read more|click here|apply|apply now|details|more info|here|link|view|download|application)$/i.test(text) || text.length < 5) {
                    if (ariaLabel && ariaLabel.trim().length > 5) {
                        text = ariaLabel.trim();
                    } else if (linkTitle && linkTitle.trim().length > 5) {
                        text = linkTitle.trim();
                    } else {
                        // Try to find a heading in current or parent containers
                        let parent = link.closest('article, section, div, li, tr, td');
                        let heading = null;
                        let currentSearch = parent;
                        for (let depth = 0; depth < 3 && currentSearch && !heading; depth++) {
                            heading = currentSearch.querySelector('h1, h2, h3, h4, h5, h6, strong, b');
                            if (!heading) {
                                // Try previous sibling if we're in a container that might be just the link
                                let prev = currentSearch.previousElementSibling;
                                if (prev) heading = prev.querySelector('h1, h2, h3, h4, h5, h6, strong, b') || (['H1','H2','H3','H4','H5','H6','STRONG','B'].includes(prev.tagName) ? prev : null);
                            }
                            if (!heading) currentSearch = currentSearch.parentElement;
                        }

                        if (heading && heading.textContent.trim().length > 5) {
                            text = heading.textContent.trim();
                        }
                    }
                }

                // Basic validation
                if (!href || seen.has(fullUrl)) continue;
                if (href.startsWith('javascript:') || href.startsWith('mailto:') || href.startsWith('tel:') || href === '#') continue;
                if (href.length < 5 || text.length < 5) continue;
                
                // BLACKLIST CHECK FIRST (including extensions now)
                if (isBlacklisted(fullUrl, text)) {
                    blacklistBlocked++;
                    state.blockedResults.push({
                        url: fullUrl,
                        title: text.substring(0, 80),
                        source: source.name,
                        reason: 'Blacklist match'
                    });
                    continue;
                }
                
                // WHITELIST CHECK - Must match funding patterns
                const combined = (text + ' ' + href).toLowerCase();
                const passesWhitelist = whitelistPatterns.some(pattern => pattern.test(combined));
                
                if (!passesWhitelist) {
                    // Additional check: if it contains funding keywords AND action keywords, allow it
                    const hasFunding = /fund|grant|award|scheme|programme|bursary/i.test(combined);
                    const hasAction = /apply|application|criteria|guidance|information|detail/i.test(combined);
                    if (!(hasFunding && hasAction)) {
                        continue;
                    }
                }
                
                whitelistPassed++;
                
                // Get context
                const context = parent ? parent.textContent : '';
                const fullCombined = (text + ' ' + href + ' ' + context).toLowerCase();
                
                // Skip closed or suspended funds
                if (/closed to applications|currently closed|suspended|paused|no longer accepting|stopped accepting|fully committed|reached capacity|all funds allocated|not currently accepting/i.test(fullCombined)) {
                    continue;
                }

                // Relevance analysis
                const match = analyseRelevance(fullCombined, source.keywords);
                
                if (match.score >= 40) { // Higher threshold for ultimate quality
                    const details = await extractDetails(parent, link, fullCombined);
                    
                    // QUALITY GATE - Only include if we have substantial info
                    const quality = calculateQuality(details);
                    
                    if (quality.score >= 30) { // Minimum quality threshold
                        results.push({
                            id: crypto.randomUUID(),
                            title: text.length > 120 ? text.substring(0, 117) + '...' : text,
                            funder: source.name,
                            url: fullUrl,
                            amount: details.amount,
                            deadline: details.deadline,
                            category: details.category,
                            criteria: details.criteria,
                            description: details.description,
                            email: details.email,
                            geography: details.geography,
                            keywords: match.keywords,
                            score: match.score,
                            quality: quality.level,
                            qualityScore: quality.score,
                            type: href.endsWith('.pdf') ? 'PDF Application' : 'Web Portal',
                            dateDiscovered: new Date().toISOString(),
                            verified: quality.score >= 70
                        });
                        
                        seen.add(fullUrl);
                    }
                }
            }
            
            log(`  Whitelist passed: ${whitelistPassed}, Blacklist blocked: ${blacklistBlocked}`, 'info');
            
            return results;
        }

        function isBlacklisted(url, text = '') {
            const urlLower = url.toLowerCase();
            const textLower = text.toLowerCase();
            const combined = urlLower + ' ' + textLower;
            
            // Core irrelevance patterns (always active)
            const coreIrrelevant = [/logo/i, /branding/i, /press kit/i, /media kit/i, /identity guidelines/i, /pixel/i, /tracking/i, /analytics/i, /favicon/i, /wp-content/i, /wp-includes/i, /node_modules/i, /cgi-bin/i];
            if (coreIrrelevant.some(p => p.test(combined))) return true;

            return state.blacklist.some(item => {
                if (!item.active) return false;
                const pattern = item.pattern.toLowerCase();
                // Match as file extension or as part of string
                if (pattern.startsWith('.')) {
                    return urlLower.endsWith(pattern) || urlLower.includes(pattern + '?') || urlLower.includes(pattern + '#');
                }
                return combined.includes(pattern);
            });
        }

        function updatePriorityArea() {
            if (!state.settings) state.settings = {};
            state.settings.priorityArea = document.getElementById('priority-area').value;
            saveData();
            applyFilters();
        }

        function analyseRelevance(text, sourceKeywords) {
            let score = 0;
            const foundKeywords = [];
            const matchDetails = [];
            
            // ENHANCED KEYWORD MATCHING
            const fundingTerms = ['fund', 'grant', 'award', 'scheme', 'programme', 'support', 'finance', 'bursary', 'funding', 'money', 'investment', 'capital', 'revenue', 'subsidy', 'pot'];
            const scotlandTerms = ['scotland', 'scottish', 'scot', 'alba', 'highlands', 'islands', 'lowlands', 'central belt', 'argyll', 'orkney', 'shetland', 'hebrides', 'gaeltacht', 'grampian', 'tayside', 'lothian', 'borders', 'strathclyde', 'forth valley'];
            const targetTerms = ['play', 'outdoor', 'community', 'youth', 'charity', 'voluntary', 'organisation', 'children', 'sport', 'education', 'environment', 'health', 'wellbeing', 'social', 'heritage', 'culture', 'arts', 'sustainability', 'nursery', 'pre-school', 'toddler', 'elderly', 'disability', 'inclusion', 'diversity', 'equality', 'poverty', 'crisis', 'homeless', 'veterans', 'mental health'];
            const orgTerms = ['cic', 'scio', 'charity', 'voluntary group', 'trust', 'foundation', 'social enterprise', 'community interest company', 'scottish charitable incorporated organisation', 'third sector', 'ngo'];
            const actionTerms = ['apply', 'application', 'guidance', 'criteria', 'eligibility', 'how to', 'deadline', 'information', 'details', 'prospectus', 'framework', 'form', 'portal'];
            
            let fundingMatch = false;
            fundingTerms.forEach(term => { if (text.includes(term)) fundingMatch = true; });
            if (fundingMatch) { score += 15; foundKeywords.push('funding'); matchDetails.push({ key: 'Funding Context', points: 15 }); }

            let scotMatch = false;
            scotlandTerms.forEach(term => { if (text.includes(term)) scotMatch = true; });
            if (scotMatch) { score += 12; foundKeywords.push('scotland'); matchDetails.push({ key: 'Scottish Focus', points: 12 }); }

            targetTerms.forEach(term => {
                if (text.includes(term)) {
                    score += 10;
                    foundKeywords.push(term);
                    matchDetails.push({ key: `Topic: ${term}`, points: 10 });
                }
            });

            orgTerms.forEach(term => {
                if (text.includes(term)) {
                    score += 15;
                    foundKeywords.push(term);
                    matchDetails.push({ key: `Org Type: ${term}`, points: 15 });
                }
            });

            let actionMatch = false;
            actionTerms.forEach(term => { if (text.includes(term)) actionMatch = true; });
            if (actionMatch) { score += 8; foundKeywords.push('actionable'); matchDetails.push({ key: 'Apply Instructions', points: 8 }); }

            sourceKeywords.forEach(term => {
                if (text.includes(term.toLowerCase())) {
                    score += 15;
                    matchDetails.push({ key: `Funder Match: ${term}`, points: 15 });
                }
            });
            
            // Bonus for specific amounts and dates
            if (/¬£[\d,]+/.test(text)) { score += 10; matchDetails.push({ key: 'Amount Found', points: 10 }); }
            if (/\d{1,2}\/\d{1,2}\/\d{4}|\d{1,2}\s+\w+\s+\d{4}/.test(text)) { score += 10; matchDetails.push({ key: 'Deadline Found', points: 10 }); }

            // Priority Area Boost
            if (state.settings && state.settings.priorityArea && state.settings.priorityArea !== 'National') {
                const area = state.settings.priorityArea;
                if (text.toLowerCase().includes(area.toLowerCase())) {
                    score += 40;
                    matchDetails.push({ key: `Priority Area: ${area}`, points: 40 });
                }
            }

            // User Interest Boost
            if (state.user && state.user.interests) {
                state.user.interests.forEach(interest => {
                    if (text.toLowerCase().includes(interest.toLowerCase())) {
                        score += 25;
                        foundKeywords.push(interest);
                        matchDetails.push({ key: `User Interest: ${interest}`, points: 25 });
                    }
                });
            }

            // Org Type Boost
            if (state.user && state.user.orgType) {
                const orgType = state.user.orgType.toLowerCase();
                if (text.toLowerCase().includes(orgType)) {
                    score += 20;
                    matchDetails.push({ key: `Matching Org Type: ${state.user.orgType}`, points: 20 });
                }
            }
            
            return { score, keywords: [...new Set(foundKeywords)], matchDetails };
        }

        async function extractDetails(element, link, text) {
            const details = {
                amount: 'Amount varies - see website',
                deadline: 'Rolling deadline',
                category: [],
                criteria: 'Visit the website for full eligibility criteria and application details',
                description: 'Funding opportunity for Scottish organisations',
                email: 'Check Portal',
                geography: 'Scotland (Various)'
            };
            
            // IMPROVED AMOUNT EXTRACTION with more patterns
            const amountPatterns = [
                /¬£?([\d,kKmM.]+(?:\.\d{2})?)\s*(?:to|-|and|‚Äì|up to)\s*¬£?([\d,kKmM.]+(?:\.\d{2})?)/i,
                /(?:between|from)\s*¬£?([\d,kKmM.]+(?:\.\d{2})?)\s*(?:to|-|and)\s*¬£?([\d,kKmM.]+(?:\.\d{2})?)/i,
                /(?:up\s+to|maximum|max|grants?\s+of|awards?\s+of|valued\s+at)\s*¬£?([\d,kKmM.]+(?:\.\d{2})?)/i,
                /¬£?([\d,kKmM.]+(?:\.\d{2})?)\s*(?:available|grants?|funding|award|total)/i,
                /grants?\s+(?:of|up to|around)\s*¬£?([\d,kKmM.]+)/i,
                /(?:¬£|gbp)\s*([\d,kKmM.]+)/i
            ];
            
            for (const pattern of amountPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (match[2]) {
                        details.amount = `¬£${match[1]} - ¬£${match[2]}`;
                    } else {
                        details.amount = match[0].includes('up to') || match[0].includes('max') ? `Up to ¬£${match[1]}` : `¬£${match[1]}`;
                    }
                    break;
                }
            }
            
            // IMPROVED DEADLINE EXTRACTION
            const deadlinePatterns = [
                /deadline[:\s]+(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i,
                /closes?[:\s]+(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i,
                /(?:by|before|until)[:\s]+(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i,
                /apply by[:\s]+(\d{1,2}(?:st|nd|rd|th)?\s+\w+\s+\d{4})/i,
                /(\d{1,2}[/-]\d{1,2}[/-]\d{2,4})/,
                /(\d{1,2}\s+\w+\s+\d{2,4})/,
                /(\w+\s+\d{1,2}(?:st|nd|rd|th)?,?\s+\d{4})/
            ];
            
            for (const pattern of deadlinePatterns) {
                const match = text.match(pattern);
                if (match) {
                    details.deadline = match[1];
                    break;
                }
            }
            
            if (text.includes('rolling') || text.includes('ongoing') || text.includes('no deadline') || text.includes('open')) {
                details.deadline = 'Rolling deadline';
            }
            
            // ENHANCED CATEGORISATION (11 categories)
            const categories = [];
            if (text.includes('play') || text.includes('outdoor') || text.includes('recreation') || text.includes('park')) categories.push('play');
            if (text.includes('community') || text.includes('local') || text.includes('neighbourhood') || text.includes('village') || text.includes('area')) categories.push('community');
            if (text.includes('youth') || text.includes('children') || text.includes('young people') || text.includes('under 25')) categories.push('youth');
            if (text.includes('charity') || text.includes('charitable') || text.includes('third sector') || text.includes('voluntary') || text.includes('non-profit')) categories.push('charity');
            if (text.includes('arts') || text.includes('culture') || text.includes('creative') || text.includes('music') || text.includes('theatre')) categories.push('arts');
            if (text.includes('sport') || text.includes('physical') || text.includes('fitness') || text.includes('active') || text.includes('leisure')) categories.push('sport');
            if (text.includes('education') || text.includes('training') || text.includes('learning') || text.includes('skills') || text.includes('school')) categories.push('education');
            if (text.includes('environment') || text.includes('conservation') || text.includes('green') || text.includes('nature') || text.includes('climate') || text.includes('biodiversity')) categories.push('environment');
            if (text.includes('health') || text.includes('wellbeing') || text.includes('mental') || text.includes('care') || text.includes('medical') || text.includes('disability')) categories.push('health');
            if (text.includes('heritage') || text.includes('historic') || text.includes('building') || text.includes('conservation') || text.includes('monument')) categories.push('heritage');
            if (text.includes('social') || text.includes('poverty') || text.includes('trauma') || text.includes('inclusion') || text.includes('equity') || text.includes('diversity')) categories.push('social');
            
            details.category = categories.length > 0 ? categories : ['general'];

            // EMAIL EXTRACTION
            const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
            if (emailMatch) details.email = emailMatch[0];

            // GEOGRAPHY DETECTION
            const regions = ['Highlands', 'Islands', 'Argyll', 'Bute', 'Ayrshire', 'Lothian', 'Borders', 'Fife', 'Grampian', 'Tayside', 'Central', 'Lanarkshire', 'Glasgow', 'Edinburgh', 'Aberdeen', 'Dundee', 'Inverness', 'Perth', 'Stirling', 'Western Isles', 'Shetland', 'Orkney', 'Moray', 'Angus', 'Dumfries', 'Galloway', 'Falkirk', 'Renfrewshire', 'Inverclyde', 'Clackmannanshire'];
            for (const region of regions) {
                if (text.includes(region.toLowerCase())) {
                    details.geography = region;
                    break;
                }
            }
            
            // IMPROVED CRITERIA & DESCRIPTION EXTRACTION
            if (element) {
                const paragraphs = Array.from(element.querySelectorAll('p, li, dd, td'));
                let criteriaText = '';
                let descText = '';
                
                paragraphs.forEach(p => {
                    const pText = p.textContent.trim();
                    if (pText.length > 20 && pText.length < 800) {
                        const pLower = pText.toLowerCase();
                        if (pLower.includes('eligib') || pLower.includes('criteria') || pLower.includes('who can apply') || pLower.includes('can apply')) {
                            criteriaText += pText + ' ';
                        } else if (pLower.includes('purpose') || pLower.includes('aim') || pLower.includes('support') || pLower.includes('fund') || pLower.includes('help')) {
                            descText += pText + ' ';
                        }
                    }
                });
                
                if (criteriaText.length > 50) details.criteria = criteriaText.trim().substring(0, 500);
                if (descText.length > 50) details.description = descText.trim().substring(0, 600);
            }
            
            return details;
        }

        function calculateQuality(details) {
            let score = 0;
            
            // Amount quality (max 35)
            if (!details.amount.includes('varies') && !details.amount.includes('see website')) score += 35;
            else if (details.amount.match(/¬£[\d,]+/)) score += 20;
            
            // Deadline quality (max 25)
            if (!details.deadline.includes('Rolling') && details.deadline.match(/\d{1,2}/)) score += 25;
            else if (details.deadline.includes('Rolling')) score += 15;
            
            // Criteria quality (max 20)
            if (details.criteria.length > 150) score += 20;
            else if (details.criteria.length > 75) score += 10;
            
            // Description quality (max 20)
            if (details.description.length > 150) score += 20;
            else if (details.description.length > 75) score += 10;
            
            let level = 'low';
            if (score >= 75) level = 'high'; // Verified
            else if (score >= 45) level = 'medium'; // Partial
            
            return { score, level };
        }

        function resolveUrl(base, relative) {
            try { return new URL(relative, base).href; } 
            catch(e) { return relative.startsWith('http') ? relative : base; }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ========== BLACKLIST MANAGEMENT ==========
        function renderBlacklist() {
            const container = document.getElementById('blacklist-items');
            if (state.blacklist.length === 0) {
                container.innerHTML = '<p class="text-slate-400 italic text-sm">No blacklist patterns added</p>';
                return;
            }
            
            container.innerHTML = state.blacklist.map((item, index) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg ${!item.active ? 'blacklisted-item' : ''}">
                    <div class="flex-1">
                        <p class="font-bold text-sm">${item.pattern}</p>
                        ${item.description ? `<p class="text-xs text-slate-500">${item.description}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleBlacklistItem(${index})" class="p-1.5 hover:bg-white rounded text-slate-600" title="${item.active ? 'Disable' : 'Enable'}">
                            <i data-lucide="${item.active ? 'eye-off' : 'eye'}" class="w-4 h-4"></i>
                        </button>
                        <button onclick="removeBlacklistItem(${index})" class="p-1.5 hover:bg-red-50 rounded text-red-600" title="Remove">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderBlockedResults() {
            const container = document.getElementById('blocked-results');
            if (state.blockedResults.length === 0) {
                container.innerHTML = '<p class="text-slate-400 italic">No blocked results yet. Run a scan to see what gets filtered.</p>';
                return;
            }
            
            container.innerHTML = state.blockedResults.slice(0, 20).map(item => `
                <div class="p-2 bg-red-50 rounded border border-red-100">
                    <p class="font-bold text-xs text-slate-700 truncate">${item.title}</p>
                    <p class="text-xs text-slate-500 truncate">${item.url}</p>
                    <p class="text-xs text-red-700 mt-1">From: ${item.source}</p>
                </div>
            `).join('');
        }

        function showAddBlacklistModal() {
            document.getElementById('add-blacklist-modal').classList.remove('hidden');
        }

        function hideAddBlacklistModal() {
            document.getElementById('add-blacklist-modal').classList.add('hidden');
            document.getElementById('new-blacklist-pattern').value = '';
            document.getElementById('new-blacklist-desc').value = '';
        }

        function addBlacklistPattern() {
            const pattern = document.getElementById('new-blacklist-pattern').value.trim();
            const description = document.getElementById('new-blacklist-desc').value.trim();
            
            if (!pattern) {
                alert('Please enter a pattern');
                return;
            }
            
            state.blacklist.push({
                pattern,
                description: description || `Custom: ${pattern}`,
                active: true
            });
            
            saveData();
            renderBlacklist();
            hideAddBlacklistModal();
            log(`‚úì Added blacklist pattern: ${pattern}`, 'success');
        }

        function toggleBlacklistItem(index) {
            state.blacklist[index].active = !state.blacklist[index].active;
            saveData();
            renderBlacklist();
            log(`${state.blacklist[index].active ? '‚úì Enabled' : '‚ö† Disabled'} blacklist: ${state.blacklist[index].pattern}`, 'warn');
        }

        function removeBlacklistItem(index) {
            if (!confirm('Remove this blacklist pattern?')) return;
            const pattern = state.blacklist[index].pattern;
            state.blacklist.splice(index, 1);
            saveData();
            renderBlacklist();
            log(`‚úó Removed blacklist: ${pattern}`, 'warn');
        }

        function blacklistThisURL() {
            if (!currentDetailURL) return;
            
            const url = new URL(currentDetailURL);
            const path = url.pathname;
            
            if (confirm(`Block all pages containing: "${path}"`)) {
                state.blacklist.push({
                    pattern: path,
                    description: `User-blocked: ${path}`,
                    active: true
                });
                saveData();
                renderBlacklist();
                hideDetailsModal();
                log(`‚úì Blacklisted: ${path}`, 'success');
            }
        }

        // ========== SHORTLIST MANAGEMENT ==========
        function toggleShortlist(id) {
            const index = state.shortlist.findIndex(o => o.id === id);
            if (index === -1) {
                const opp = state.opportunities.find(o => o.id === id);
                if (opp) {
                    state.shortlist.push(opp);
                    log(`‚≠ê Added to Shortlist: ${opp.title}`, 'success');
                }
            } else {
                const removed = state.shortlist.splice(index, 1);
                log(`‚≠ê Removed from Shortlist: ${removed[0].title}`, 'warn');
            }
            saveData();
            renderDashboard();
            renderShortlist();
        }

        function renderShortlist() {
            const tbody = document.getElementById('shortlist-tbody');
            const empty = document.getElementById('shortlist-empty');

            if (!tbody) return;

            if (state.shortlist.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                tbody.innerHTML = state.shortlist.map(opp => `
                    <tr class="hover:bg-slate-50 cursor-pointer" onclick="showDetails('${opp.id}')">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-900 mb-1">${opp.title}</div>
                            <div class="text-xs text-slate-500">${opp.funder}</div>
                        </td>
                        <td class="px-6 py-4 font-bold text-green-600">${opp.amount}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${getStatusColor(opp.applicationStatus)}">
                                ${opp.applicationStatus || 'Not Started'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="event.stopPropagation(); toggleShortlist('${opp.id}')" class="p-2 text-amber-500 hover:bg-amber-50 rounded-lg transition-all" title="Remove from Shortlist">
                                    <i data-lucide="star" class="w-4 h-4 fill-amber-500"></i>
                                </button>
                                <a href="${opp.url}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-slate-100 rounded-lg inline-block hover:bg-indigo-600 hover:text-white transition-all">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            lucide.createIcons();
        }

        function getStatusColor(status) {
            switch (status) {
                case 'In Progress': return 'bg-blue-100 text-blue-700';
                case 'Submitted': return 'bg-purple-100 text-purple-700';
                case 'Awarded': return 'bg-green-100 text-green-700';
                case 'Declined': return 'bg-red-100 text-red-700';
                default: return 'bg-slate-100 text-slate-700';
            }
        }

        function exportShortlistCSV() {
            if (state.shortlist.length === 0) {
                alert('Shortlist is empty');
                return;
            }
            const headers = ['Title', 'Funder', 'Amount', 'Deadline', 'URL'];
            const rows = state.shortlist.map(opp => [opp.title, opp.funder, opp.amount, opp.deadline, opp.url]);
            let csv = headers.join(',') + '\n';
            rows.forEach(row => { csv += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n'; });
            downloadFile('scotfund-shortlist.csv', csv, 'text/csv');
        }

        // ========== ENHANCED UI RENDERING ==========
        function renderDashboard() {
            const tbody = document.getElementById('opp-tbody');
            const empty = document.getElementById('empty-state');
            
            const filtered = applyFilters(true);
            
            document.getElementById('filtered-count').textContent = filtered.length > 0 ? `(${filtered.length} showing)` : '';
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                
                // Update top 3 opportunities
                const top3 = filtered.slice(0, 3);
                const container = document.getElementById('top-3-container');

                if (container) {
                    const placeholders = [
                        { title: 'Ready to Scan', desc: 'Run a scan to discover top verified funding opportunities across Scotland.', color: 'indigo' },
                        { title: 'Advanced Ranking', desc: 'Our intelligence engine ranks funds by relevance, quality, and urgency.', color: 'purple' },
                        { title: 'Verified Links', desc: 'Direct access to official application forms and eligibility guidance.', color: 'slate' }
                    ];

                    let html = '';
                    for (let i = 0; i < 3; i++) {
                        if (top3[i]) {
                            const opp = top3[i];
                            const gradients = [
                                'from-indigo-900 to-indigo-800 border-indigo-700 shadow-indigo-100/50',
                                'from-purple-900 to-purple-800 border-purple-700 shadow-purple-100/50',
                                'from-slate-900 to-slate-800 border-slate-700 shadow-slate-100/50'
                            ];
                            const textColors = ['text-indigo-300', 'text-purple-300', 'text-slate-300'];

                            html += `
                                <div class="bg-gradient-to-br ${gradients[i]} rounded-2xl p-6 text-white border shadow-xl flex flex-col cursor-pointer hover:scale-[1.02] transition-transform" onclick="showDetails('${opp.id}')">
                                    <p class="${textColors[i]} text-[10px] font-bold uppercase tracking-widest mb-2">‚≠ê Top Pick ${i + 1}</p>
                                    <h3 class="text-lg font-bold mb-2 line-clamp-2">${opp.title}</h3>
                                    <p class="text-white/70 text-xs mb-4 leading-relaxed line-clamp-3">${opp.description}</p>
                                    <div class="mt-auto space-y-2">
                                        <div class="flex items-center justify-between text-[10px] font-bold opacity-80 mb-1">
                                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> Found: ${new Date(opp.dateDiscovered).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</span>
                                            <span class="px-1.5 py-0.5 bg-white/20 rounded-md">‚≠ê Top Quality</span>
                                        </div>
                                        <div class="flex items-center justify-between text-[11px] font-bold">
                                            <span class="flex items-center gap-1.5"><i data-lucide="coins" class="w-3.5 h-3.5"></i> ${opp.amount}</span>
                                            <span class="flex items-center gap-1.5"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${opp.deadline}</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <a href="${opp.url}" target="_blank" onclick="event.stopPropagation()" class="flex-1 bg-white/10 hover:bg-white/20 text-white text-center py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2">
                                                View Portal <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                                            </a>
                                            <button onclick="event.stopPropagation(); toggleShortlist('${opp.id}')" class="px-3 bg-white/10 hover:bg-white/20 rounded-lg transition-all" title="Shortlist">
                                                <i data-lucide="star" class="w-3.5 h-3.5 ${state.shortlist.some(s => s.id === opp.id) ? 'fill-white' : ''}"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            const p = placeholders[i];
                            const gradients = {
                                indigo: 'from-indigo-900 to-indigo-800 border-indigo-700',
                                purple: 'from-purple-900 to-purple-800 border-purple-700',
                                slate: 'from-slate-900 to-slate-800 border-slate-700'
                            };
                            const textColors = {
                                indigo: 'text-indigo-300',
                                purple: 'text-purple-300',
                                slate: 'text-slate-300'
                            };
                            html += `
                                <div class="bg-gradient-to-br ${gradients[i === 0 ? 'indigo' : i === 1 ? 'purple' : 'slate']} rounded-2xl p-6 text-white border opacity-50 flex flex-col">
                                    <p class="${textColors[i === 0 ? 'indigo' : i === 1 ? 'purple' : 'slate']} text-[10px] font-bold uppercase tracking-widest mb-2">‚≠ê Top Pick ${i + 1}</p>
                                    <h3 class="text-lg font-bold mb-2">${p.title}</h3>
                                    <p class="text-white/60 text-xs mb-4 leading-relaxed">${p.desc}</p>
                                </div>
                            `;
                        }
                    }
                    container.innerHTML = html;
                    lucide.createIcons();
                }
                
                tbody.innerHTML = filtered.map(opp => {
                    const qualityBadge = opp.verified ? 
                        `<span class="quality-badge quality-high">‚≠ê Verified</span>` :
                        opp.quality === 'medium' ?
                        `<span class="quality-badge quality-medium">üìã Partial</span>` :
                        `<span class="quality-badge quality-low">‚ö†Ô∏è Basic</span>`;
                    
                    const isSelected = state.selectedIds.has(opp.id);

                    return `
                        <tr class="hover:bg-slate-50 cursor-pointer" onclick="showDetails('${opp.id}')">
                            <td class="px-6 py-4" onclick="event.stopPropagation()">
                                <input type="checkbox" onchange="toggleSelection('${opp.id}')" ${isSelected ? 'checked' : ''} class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-900 mb-1">${opp.title}</div>
                                <div class="text-xs text-slate-500">${opp.funder}</div>
                            </td>
                            <td class="px-6 py-4 font-bold ${opp.amount.includes('varies') ? 'text-slate-500' : 'text-green-600'}">${opp.amount}</td>
                            <td class="px-6 py-4 text-sm ${opp.deadline.includes('Rolling') ? 'text-slate-500' : 'text-orange-600'}">${opp.deadline}</td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-1">
                                    ${opp.category.slice(0, 2).map(cat => `<span class="inline-block px-2 py-1 bg-indigo-50 text-indigo-600 rounded text-xs font-bold">${cat}</span>`).join('')}
                                    ${opp.category.length > 2 ? `<span class="inline-block px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-bold">+${opp.category.length - 2}</span>` : ''}
                                </div>
                            </td>
                            <td class="px-6 py-4">${qualityBadge}</td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end gap-2">
                                    <button onclick="event.stopPropagation(); toggleShortlist('${opp.id}')" class="p-2 hover:bg-amber-50 rounded-lg transition-all ${state.shortlist.some(s => s.id === opp.id) ? 'text-amber-500' : 'text-slate-400'}" title="Shortlist">
                                        <i data-lucide="star" class="w-4 h-4 ${state.shortlist.some(s => s.id === opp.id) ? 'fill-amber-500' : ''}"></i>
                                    </button>
                                    <a href="${opp.url}" target="_blank" onclick="event.stopPropagation()" class="p-2 bg-slate-100 rounded-lg inline-block hover:bg-indigo-600 hover:text-white transition-all">
                                        <i data-lucide="external-link" class="w-4 h-4"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            lucide.createIcons();
        }

        function applyFilters(returnData = false) {
            const search = document.getElementById('search-input')?.value.toLowerCase() || '';
            const category = document.getElementById('filter-category')?.value || '';
            const amount = document.getElementById('filter-amount')?.value || '';
            const deadline = document.getElementById('filter-deadline')?.value || '';
            const quality = document.getElementById('filter-quality')?.value || '';
            const recommended = document.getElementById('filter-recommended')?.checked || false;
            
            let filtered = [...state.opportunities];

            if (recommended) {
                filtered = filtered.filter(opp => opp.score >= 80);
            }
            
            if (search) {
                filtered = filtered.filter(opp => 
                    opp.title.toLowerCase().includes(search) ||
                    opp.funder.toLowerCase().includes(search) ||
                    opp.description.toLowerCase().includes(search) ||
                    opp.keywords.some(k => k.toLowerCase().includes(search))
                );
            }
            
            if (category) {
                filtered = filtered.filter(opp => opp.category.includes(category));
            }
            
            if (amount) {
                filtered = filtered.filter(opp => {
                    const oppAmount = extractNumericAmount(opp.amount);
                    if (oppAmount === 0) return false;
                    const [min, max] = amount.split('-').map(v => parseInt(v) || Infinity);
                    return oppAmount >= min && (max ? oppAmount <= max : true);
                });
            }
            
            if (quality) {
                if (quality === 'high') filtered = filtered.filter(opp => opp.verified);
                else if (quality === 'medium') filtered = filtered.filter(opp => opp.quality !== 'low');
            }
            
            if (deadline) {
                filtered = filtered.filter(opp => {
                    if (deadline === 'rolling') return opp.deadline.includes('Rolling');
                    return !opp.deadline.includes('Rolling');
                });
            }
            
            filtered.sort((a, b) => {
                // Prioritise verified, then quality score, then relevance
                if (a.verified !== b.verified) return b.verified ? 1 : -1;
                if (b.qualityScore !== a.qualityScore) return b.qualityScore - a.qualityScore;
                return b.score - a.score;
            });
            
            if (returnData) return filtered;
            
            renderDashboard();
        }

        function extractNumericAmount(amountStr) {
            if (!amountStr) return 0;
            // Find all ¬£ amounts and capture optional k/m suffix
            const matches = amountStr.matchAll(/¬£([\d,.]+)\s*([kKmM])?/gi);
            let maxVal = 0;

            for (const match of matches) {
                let val = parseFloat(match[1].replace(/,/g, ''));
                const suffix = match[2] ? match[2].toLowerCase() : '';

                if (suffix === 'k') val *= 1000;
                else if (suffix === 'm') val *= 1000000;

                if (val > maxVal) maxVal = val;
            }

            return Math.round(maxVal);
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = state.opportunities.length;
            
            const verified = state.opportunities.filter(opp => opp.verified).length;
            document.getElementById('stat-verified').textContent = verified;
            
            const closingSoon = state.opportunities.filter(opp => {
                if (opp.deadline.includes('Rolling')) return false;
                const currentMonth = new Date().toLocaleDateString('en-GB', { month: 'long' });
                return opp.deadline.includes(currentMonth);
            }).length;
            document.getElementById('stat-closing').textContent = closingSoon;
            
            const largeGrants = state.opportunities.filter(opp => extractNumericAmount(opp.amount) >= 25000).length;
            document.getElementById('stat-large').textContent = largeGrants;
            
            const amounts = state.opportunities.map(opp => extractNumericAmount(opp.amount)).filter(a => a > 0);
            const avg = amounts.length > 0 ? Math.round(amounts.reduce((a, b) => a + b, 0) / amounts.length) : 0;
            document.getElementById('stat-avg').textContent = avg > 0 ? `¬£${avg.toLocaleString('en-GB')}` : '¬£0';
            
            if (state.lastScan) {
                const lastScan = new Date(state.lastScan);
                document.getElementById('stat-last-scan').textContent = lastScan.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            }
        }

        function toggleScanUI(active) {
            state.isScanning = active;
            const scanButtons = document.querySelectorAll('button[onclick="runUltimateScan()"]');
            const btnText = document.getElementById('btn-text');
            const icon = document.getElementById('btn-icon');
            const indicator = document.getElementById('scan-status-indicator');
            const progressContainer = document.getElementById('global-progress-container');
            const progressBar = document.getElementById('global-progress-bar');

            scanButtons.forEach(btn => {
                btn.disabled = active;
                btn.classList.toggle('opacity-50', active);
            });

            if (active) {
                if (icon) icon.classList.add('animate-spin');
                if (btnText) btnText.textContent = 'Fetching...';
                if (indicator) indicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-purple-500 scanning-active"></span> Scanning...`;
                if (progressContainer) progressContainer.classList.remove('hidden');
                if (progressBar) progressBar.style.width = '0%';
            } else {
                if (icon) icon.classList.remove('animate-spin');
                if (btnText) btnText.textContent = 'Scan';
                if (indicator) indicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Ready`;
                if (progressContainer) progressContainer.classList.add('hidden');
                lucide.createIcons();
            }
        }

        // ========== DETAILS MODAL ==========
        let currentDetailID = '';
        let isEditMode = false;

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            const saveBtn = document.getElementById('save-edit-btn');

            const titleText = document.getElementById('detail-title');
            const titleInput = document.getElementById('edit-title-input');
            const deadlineInput = document.getElementById('edit-deadline-input');
            const categoryInput = document.getElementById('edit-category-input');

            if (isEditMode) {
                btn.textContent = 'Cancel Edit';
                btn.classList.add('text-red-600');
                saveBtn.classList.remove('hidden');

                titleText.classList.add('hidden');
                titleInput.classList.remove('hidden');
                titleInput.value = titleText.textContent;

                deadlineInput.classList.remove('hidden');
                categoryInput.classList.remove('hidden');

                const opp = state.opportunities.find(o => o.id === currentDetailID) || state.shortlist.find(o => o.id === currentDetailID);
                categoryInput.value = opp ? opp.category.join(', ') : '';
            } else {
                btn.textContent = 'Edit Mode';
                btn.classList.remove('text-red-600');
                saveBtn.classList.add('hidden');

                titleText.classList.remove('hidden');
                titleInput.classList.add('hidden');
                deadlineInput.classList.add('hidden');
                categoryInput.classList.add('hidden');
            }
        }

        function saveEdits() {
            const title = document.getElementById('edit-title-input').value.trim();
            const deadline = document.getElementById('edit-deadline-input').value;
            const categories = document.getElementById('edit-category-input').value.split(',').map(c => c.trim()).filter(c => c);

            if (!title) {
                alert('Title cannot be empty');
                return;
            }

            // Update state
            const updateObj = (list) => {
                const item = list.find(o => o.id === currentDetailID);
                if (item) {
                    item.title = title;
                    if (deadline) item.deadline = new Date(deadline).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    item.category = categories;
                }
            };

            updateObj(state.opportunities);
            updateObj(state.shortlist);

            saveData();
            toggleEditMode();
            showDetails(currentDetailID); // Refresh modal content
            renderDashboard();
            renderShortlist();
            log(`‚úì Changes saved for: ${title}`, 'success');
        }

        function toggleShortlistFromModal() {
            if (currentDetailID) {
                toggleShortlist(currentDetailID);
                updateModalShortlistButton();
            }
        }

        function updateModalShortlistButton() {
            const isShortlisted = state.shortlist.some(s => s.id === currentDetailID);
            const icon = document.getElementById('modal-shortlist-icon');

            if (isShortlisted) {
                icon.classList.add('fill-amber-500');
            } else {
                icon.classList.remove('fill-amber-500');
            }
        }

        function generateChecklist(text) {
            const container = document.getElementById('detail-checklist');
            if (!container) return;
            container.innerHTML = '';

            // Heuristic for actionable items
            const actionablePatterns = [
                /must (?:have|be|provide|include|show)/i,
                /provide (?:a|your|details|copies)/i,
                /include (?:a|your|details)/i,
                /show (?:how|that)/i,
                /eligible (?:to|if)/i,
                /applicants (?:must|should)/i,
                /copy of/i,
                /application form/i,
                /constitution/i,
                /accounts/i,
                /bank statement/i
            ];

            const sentences = text.split(/[.!?]+/).map(s => s.trim()).filter(s => s.length > 20);
            const items = sentences.filter(s => actionablePatterns.some(p => p.test(s)));

            if (items.length === 0) {
                container.innerHTML = '<p class="text-xs text-slate-400 italic">No specific checklist items extracted. Review the guidelines below.</p>';
                return;
            }

            items.slice(0, 6).forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-3 bg-slate-50 p-2 rounded-lg border border-slate-100';
                div.innerHTML = `
                    <input type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                    <p class="text-xs text-slate-700 leading-tight">${item}</p>
                `;
                container.appendChild(div);
            });
        }

        function showDetails(id) {
            const opp = state.opportunities.find(o => o.id === id) || state.shortlist.find(o => o.id === id);
            if (!opp) return;
            
            currentDetailID = id;
            currentDetailURL = opp.url;
            
            switchModalTab('overview');
            updateModalShortlistButton();
            generateChecklist(opp.criteria + ' ' + opp.description);

            document.getElementById('detail-title').textContent = opp.title;
            document.getElementById('detail-funder').textContent = opp.funder;
            document.getElementById('detail-amount').textContent = opp.amount;
            document.getElementById('detail-deadline').textContent = opp.deadline;
            document.getElementById('detail-category').innerHTML = opp.category.map(cat => 
                `<span class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold uppercase tracking-wider">${cat}</span>`
            ).join(' ');

            const discoveredDate = new Date(opp.dateDiscovered || new Date()).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            document.getElementById('detail-date').textContent = discoveredDate;

            const qualityText = opp.verified ? '‚≠ê Verified High' : (opp.quality === 'medium' ? 'üìã Partial Info' : '‚ö†Ô∏è Basic Info');
            const qualityColor = opp.verified ? 'text-green-600' : (opp.quality === 'medium' ? 'text-amber-600' : 'text-slate-400');
            document.getElementById('detail-quality').textContent = qualityText;
            document.getElementById('detail-quality').className = `text-sm font-bold ${qualityColor}`;

            document.getElementById('detail-geography').textContent = opp.geography || 'Scotland (Various)';
            document.getElementById('detail-email').textContent = opp.email || 'Check Portal';
            if (opp.email) {
                document.getElementById('detail-email').innerHTML = `<a href="mailto:${opp.email}" class="hover:underline text-indigo-600">${opp.email}</a>`;
            }

            document.getElementById('detail-criteria').textContent = opp.criteria;
            document.getElementById('detail-description').textContent = opp.description;
            document.getElementById('detail-keywords').innerHTML = opp.keywords.map(kw => 
                `<span class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-[10px] font-bold uppercase tracking-tight">${kw}</span>`
            ).join('');
            document.getElementById('detail-link').href = opp.url;

            // Load Notes
            const notesInput = document.getElementById('detail-notes-input');
            if (notesInput) {
                notesInput.value = opp.notes || '';
                notesInput.oninput = (e) => {
                    opp.notes = e.target.value;
                    saveData();
                };
            }

            // Load Application Status
            const statusSelect = document.getElementById('detail-app-status');
            if (statusSelect) {
                statusSelect.value = opp.applicationStatus || 'Not Started';
                statusSelect.onchange = (e) => {
                    opp.applicationStatus = e.target.value;
                    saveData();
                    if (document.getElementById('shortlist').classList.contains('hidden') === false) renderShortlist();
                    log(`‚úì Status updated: ${opp.applicationStatus}`, 'success');
                };
            }

            // Match Breakdown
            const breakdown = document.getElementById('detail-match-breakdown');
            if (breakdown) {
                if (opp.matchDetails) {
                    breakdown.innerHTML = opp.matchDetails.map(m => `
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-medium text-slate-600">${m.key}</span>
                            <span class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded uppercase tracking-widest">+${m.points} pts</span>
                        </div>
                    `).join('');
                } else {
                    breakdown.innerHTML = '<p class="text-xs text-slate-500 italic text-center py-4">Direct discovery match based on funder keywords.</p>';
                }
            }
            
            document.getElementById('details-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        async function shareOpportunity() {
            if (!currentDetailURL) return;
            try {
                await navigator.clipboard.writeText(currentDetailURL);
                alert('Application link copied to clipboard!');
            } catch (err) {
                log('Failed to copy link', 'error');
            }
        }

        function exportToICSFromModal() {
            const opp = state.opportunities.find(o => o.id === currentDetailID) || state.shortlist.find(o => o.id === currentDetailID);
            if (!opp) return;

            const customDeadline = document.getElementById('edit-deadline-input').value;
            let date;

            if (customDeadline) {
                date = new Date(customDeadline);
            } else {
                if (opp.deadline.toLowerCase().includes('rolling')) {
                    alert('This is a rolling fund with no fixed deadline. Please set a custom deadline if you want to add it to your calendar.');
                    return;
                }
                const cleanDeadline = opp.deadline.replace(/(st|nd|rd|th)/g, '');
                date = new Date(cleanDeadline);
            }

            if (!date || isNaN(date.getTime())) {
                alert('Could not determine a precise date for this deadline. Please use the Edit Mode to set a custom deadline.');
                return;
            }

            // Create ICS content
            const start = date.toISOString().replace(/-|:|\.\d+/g, '').split('T')[0] + 'T090000Z';
            const end = date.toISOString().replace(/-|:|\.\d+/g, '').split('T')[0] + 'T170000Z';

            const icsLines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//ScotFund Pro//NONSGML v1.0//EN',
                'BEGIN:VEVENT',
                `UID:${opp.id}@scotfund.pro`,
                `DTSTAMP:${new Date().toISOString().replace(/-|:|\.\d+/g, '').split('T')[0]}T000000Z`,
                `DTSTART:${start}`,
                `DTEND:${end}`,
                `SUMMARY:Deadline: ${opp.title}`,
                `DESCRIPTION:Funder: ${opp.funder}\\nAmount: ${opp.amount}\\nURL: ${opp.url}`,
                `LOCATION:${opp.url}`,
                'END:VEVENT',
                'END:VCALENDAR'
            ];

            const blob = new Blob([icsLines.join('\r\n')], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deadline-${opp.id}.ics`;
            a.click();
            URL.revokeObjectURL(url);
            log(`üìÖ Calendar event exported for: ${opp.title}`, 'success');
        }

        function hideDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
            currentDetailURL = '';
            currentDetailID = '';
            if (isEditMode) toggleEditMode(); // Reset edit mode
        }

        // ========== SOURCE MANAGEMENT ==========
        function renderSources() {
            const grid = document.getElementById('sources-grid');
            grid.innerHTML = state.sources.map(s => `
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="font-bold text-slate-900">${s.name}</h4>
                        <button onclick="removeSource('${s.id}')" class="p-1.5 hover:bg-red-50 rounded text-red-600">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-400 truncate mb-3">${s.url}</p>
                    <div class="flex flex-wrap gap-1">
                        ${s.keywords.map(kw => `<span class="text-xs bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded">${kw}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function showAddSourceModal() {
            document.getElementById('add-source-modal').classList.remove('hidden');
        }

        function hideAddSourceModal() {
            document.getElementById('add-source-modal').classList.add('hidden');
            document.getElementById('new-source-name').value = '';
            document.getElementById('new-source-url').value = '';
            document.getElementById('new-source-keywords').value = '';
        }

        function addSource() {
            const name = document.getElementById('new-source-name').value.trim();
            const url = document.getElementById('new-source-url').value.trim();
            const keywords = document.getElementById('new-source-keywords').value.split(',').map(k => k.trim()).filter(k => k);
            
            if (!name || !url || keywords.length === 0) {
                alert('Please fill in all fields');
                return;
            }
            
            const newSource = {
                id: crypto.randomUUID(),
                name,
                url,
                keywords
            };
            
            state.sources.push(newSource);
            saveData();
            renderSources();
            hideAddSourceModal();
            log(`‚úì Added source: ${name}`, 'success');
        }

        function removeSource(id) {
            if (!confirm('Remove this source?')) return;
            state.sources = state.sources.filter(s => s.id !== id);
            saveData();
            renderSources();
            log(`‚úì Source removed`, 'success');
        }

        // ========== PDF, SCHEDULER, EMAIL (Same as v3 but with verified stat) ==========
        function generatePDFReport() {
            const reportNewOnly = document.getElementById('report-new-only')?.checked;
            let list = [...state.opportunities];

            if (state.selectedIds.size > 0) {
                list = list.filter(o => state.selectedIds.has(o.id));
            }

            if (reportNewOnly) {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                list = list.filter(o => {
                    const d = new Date(o.dateDiscovered);
                    return !isNaN(d) && d > oneWeekAgo;
                });
            }

            if (list.length === 0) {
                alert('No opportunities match your selection or "New Only" criteria.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('ScotFund Pro Ultimate - Funding Report', 14, 20);
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}`, 14, 28);
            doc.text(`Total: ${list.length} | Verified: ${list.filter(o => o.verified).length}`, 14, 34);
            
            let y = 45;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Summary Statistics', 14, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const verified = list.filter(o => o.verified).length;
            const closingSoon = list.filter(o => !o.deadline.includes('Rolling')).length;
            const largeGrants = list.filter(o => extractNumericAmount(o.amount) >= 25000).length;
            
            doc.text(`‚Ä¢ Verified opportunities: ${verified}`, 14, y); y += 6;
            doc.text(`‚Ä¢ Opportunities with deadlines: ${closingSoon}`, 14, y); y += 6;
            doc.text(`‚Ä¢ Large grants (¬£25,000+): ${largeGrants}`, 14, y); y += 12;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Included Opportunities', 14, y);
            y += 8;
            
            const tableData = list.map(opp => [
                opp.title.substring(0, 45),
                opp.funder,
                opp.amount,
                opp.deadline,
                opp.verified ? 'Verified' : 'Partial'
            ]);
            
            doc.autoTable({
                startY: y,
                head: [['Opportunity', 'Funder', 'Amount', 'Deadline', 'Quality']],
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [79, 70, 229], fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 50 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 25 }
                }
            });
            
            doc.addPage();
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Top Verified Opportunities - Details', 14, 20);
            
            y = 30;
            const top10 = list.filter(o => o.verified).slice(0, 10);
            
            if (top10.length === 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Top opportunities from selection:', 14, y);
                y += 10;
            }
            
            const oppsToPrint = top10.length > 0 ? top10 : list.slice(0, 10);
            
            oppsToPrint.forEach((opp, index) => {
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${opp.title.substring(0, 65)}`, 14, y);
                y += 7;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Funder: ${opp.funder}`, 14, y); y += 5;
                doc.text(`Amount: ${opp.amount}`, 14, y); y += 5;
                doc.text(`Deadline: ${opp.deadline}`, 14, y); y += 5;
                doc.text(`Sectors: ${opp.category.join(', ')}`, 14, y); y += 7;
                
                doc.setFontSize(8);
                const description = doc.splitTextToSize(opp.description, 180);
                doc.text(description, 14, y);
                y += description.length * 4 + 8;
                
                if (opp.criteria && !opp.criteria.includes('Visit the website')) {
                    doc.text('Eligibility: ' + doc.splitTextToSize(opp.criteria.substring(0, 200), 180), 14, y);
                    y += 12;
                }
                
                doc.setTextColor(79, 70, 229);
                doc.textWithLink('Application Link', 14, y, { url: opp.url });
                doc.setTextColor(0, 0, 0);
                y += 10;
            });
            
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`ScotFund Pro Ultimate - Page ${i} of ${pageCount}`, 14, 285);
                doc.setTextColor(0);
            }
            
            doc.save(`ScotFund-Ultimate-${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}.pdf`);
            log('‚úì PDF report generated', 'success');
        }

        // SCHEDULER, EMAIL, DATA EXPORT (Same as v3)
        function initScheduler() {
            const freq = state.schedule.frequency;
            if (freq !== 'manual') scheduleNextScan();
        }

        function loadScheduleSettings() {
            document.getElementById('scan-frequency').value = state.schedule.frequency;
            document.getElementById('scan-time').value = state.schedule.time;
            document.getElementById('email-recipients').value = state.email.recipients;
            document.getElementById('email-frequency').value = state.email.frequency;
            updateScheduleDisplay();
        }

        function updateSchedule() {
            state.schedule.frequency = document.getElementById('scan-frequency').value;
            state.schedule.time = document.getElementById('scan-time').value;
            saveData();
            scheduleNextScan();
            updateScheduleDisplay();
        }

        function updateEmailSettings() {
            state.email.recipients = document.getElementById('email-recipients').value;
            state.email.frequency = document.getElementById('email-frequency').value;
            saveData();
            log('‚úì Email reporting settings updated', 'success');
        }

        function updateWebhookSettings() {
            if (!state.settings) state.settings = {};
            state.settings.webhookUrl = document.getElementById('webhook-url').value;
            state.settings.webhookNewOnly = document.getElementById('webhook-new-only').checked;
            saveData();
        }

        async function testWebhook() {
            const url = document.getElementById('webhook-url').value;
            if (!url) return alert('Please enter a Webhook URL');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test: true,
                        message: "ScotFund Pro Webhook Test",
                        timestamp: new Date().toISOString()
                    })
                });
                alert(`Webhook sent! Status: ${response.status}`);
            } catch (err) {
                alert(`Failed to send webhook: ${err.message}`);
            }
        }

        function scheduleNextScan() {
            if (state.scanInterval) clearInterval(state.scanInterval);
            
            const freq = state.schedule.frequency;
            if (freq === 'manual') return;

            const check = () => {
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                let shouldScan = false;
                if (freq === 'hourly' && now.getMinutes() === 0) shouldScan = true;
                if (freq === 'daily' && timeStr === state.schedule.time) shouldScan = true;
                if (freq === 'weekly' && now.getDay() === 1 && timeStr === state.schedule.time) shouldScan = true; // Monday

                if (shouldScan) {
                    log('‚è∞ Scheduled scan triggered', 'info');
                    runUltimateScan(true);
                }
            };

            state.scanInterval = setInterval(check, 60000); // Check every minute
            log(`‚úì Scheduler active: ${freq} check`, 'success');
        }

        function updateScheduleDisplay() {
            const freq = state.schedule.frequency;
            const timePicker = document.getElementById('schedule-time-picker');
            const nextScanText = document.getElementById('next-scan-text');
            
            if (freq === 'manual') {
                timePicker.classList.add('hidden');
                nextScanText.textContent = 'Next scan: Manual trigger';
            } else {
                if (freq === 'daily' || freq === 'weekly') {
                    timePicker.classList.remove('hidden');
                } else {
                    timePicker.classList.add('hidden');
                }
                nextScanText.textContent = `Next scan: ${freq} ${freq !== 'hourly' ? 'at ' + state.schedule.time : ''}`;
            }
        }

        function sendTestEmail() {
            const recipients = document.getElementById('email-recipients').value;
            if (!recipients) {
                alert('Please enter email recipients first');
                return;
            }
            
            state.email.recipients = recipients;
            state.email.frequency = document.getElementById('email-frequency').value;
            saveData();
            
            const emailBody = generateEmailContent();
            const subject = encodeURIComponent('ScotFund Pro Ultimate - Test');
            const body = encodeURIComponent(emailBody);
            window.open(`mailto:${recipients}?subject=${subject}&body=${body}`);
            
            log('‚úì Test email generated', 'success');
        }

        function sendEmailNotification() {
            if (!state.email.recipients) return;
            
            const emailBody = generateEmailContent();
            const subject = encodeURIComponent('ScotFund Pro Ultimate - New Opportunities');
            const body = encodeURIComponent(emailBody);
            window.open(`mailto:${state.email.recipients}?subject=${subject}&body=${body}`);
        }

        function generateEmailContent() {
            const reportNewOnly = document.getElementById('report-new-only')?.checked;
            let list = [...state.opportunities];

            if (state.selectedIds.size > 0) {
                list = list.filter(o => state.selectedIds.has(o.id));
            }

            if (reportNewOnly) {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                list = list.filter(o => {
                    const d = new Date(o.dateDiscovered);
                    return !isNaN(d) && d > oneWeekAgo;
                });
            }

            const top5 = list.slice(0, 10);

            let content = `ScotFund Pro Ultimate - Funding Opportunities Report\n\n`;
            content += `Date: ${new Date().toLocaleDateString('en-GB')}\n`;
            content += `Total Included: ${list.length} | Verified: ${list.filter(o => o.verified).length}\n\n`;
            content += `Highlights:\n\n`;
            
            top5.forEach((opp, i) => {
                content += `${i + 1}. ${opp.title}\n`;
                content += `   Funder: ${opp.funder}\n`;
                content += `   Amount: ${opp.amount}\n`;
                content += `   Deadline: ${opp.deadline}\n`;
                content += `   Quality: ${opp.verified ? 'Verified' : 'Partial'}\n`;
                content += `   Link: ${opp.url}\n\n`;
            });
            
            return content;
        }

        function exportToCSV() {
            const list = applyFilters(true);
            if (list.length === 0) {
                alert('No filtered data to export');
                return;
            }
            
            const headers = ['Title', 'Funder', 'Amount', 'Deadline', 'Sectors', 'Area', 'Contact', 'Quality', 'Verified', 'Criteria', 'Description', 'URL'];
            const rows = list.map(opp => [
                opp.title,
                opp.funder,
                opp.amount,
                opp.deadline,
                (opp.category || []).join('; '),
                opp.geography || 'Scotland',
                opp.email || '',
                opp.quality,
                opp.verified ? 'Yes' : 'No',
                opp.criteria,
                opp.description,
                opp.url
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            downloadFile('scotfund-ultimate-opportunities.csv', csv, 'text/csv');
            log('‚úì Data exported to CSV', 'success');
        }

        function exportData() {
            const data = {
                opportunities: state.opportunities,
                blockedResults: state.blockedResults,
                sources: state.sources,
                blacklist: state.blacklist,
                schedule: state.schedule,
                email: state.email,
                settings: state.settings,
                exportDate: new Date().toISOString(),
                version: '8.0'
            };
            
            downloadFile('scotfund-ultimate-backup.json', JSON.stringify(data, null, 2), 'application/json');
            log('‚úì Full backup exported', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        state.opportunities = data.opportunities || [];
                        state.sources = data.sources || state.sources;
                        state.blacklist = data.blacklist || state.blacklist;
                        state.schedule = data.schedule || state.schedule;
                        state.email = data.email || state.email;
                        state.settings = data.settings || state.settings;
                        saveData();
                        location.reload();
                    } catch (err) {
                        alert('Invalid backup file');
                        log('‚úó Import failed', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (!confirm('This will delete all data. Continue?')) return;
            
            state.opportunities = [];
            state.blockedResults = [];
            state.sources = [...DEFAULT_SOURCES];
            state.blacklist = [...DEFAULT_BLACKLIST];
            state.schedule = { frequency: 'manual', time: '09:00' };
            state.email = { recipients: '', frequency: 'none' };
            state.settings = { webhookUrl: '', webhookNewOnly: false, priorityArea: 'National' };
            state.lastScan = null;
            
            localStorage.clear();
            saveData();
            location.reload();
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        window.onload = init;
    </script>
</body>
</html>
